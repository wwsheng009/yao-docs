{
  "name": "order-processing",
  "label": "è®¢å•å¤„ç†ç³»ç»Ÿ",
  "description": "å®Œæ•´çš„ç”µå•†è®¢å•å¤„ç†æµç¨‹",
  "whitelist": [
    "order.*",
    "inventory.*",
    "payment.*",
    "shipping.*",
    "notification.*"
  ],
  "nodes": [
    {
      "name": "receive-order",
      "input": ["{{ $global.order_data }}"],
      "process": {
        "name": "order.validate",
        "args": ["{{ $in[0] }}"]
      },
      "output": {
        "is_valid": "{{ $out.valid }}",
        "order_data": "{{ $out.order_data }}",
        "errors": "{{ $out.errors }}"
      }
    },
    {
      "name": "check-inventory",
      "case": {
        "{{ $node.receive-order.out.is_valid == true }}": {
          "name": "valid-order",
          "nodes": [
            {
              "name": "inventory-check",
              "process": {
                "name": "inventory.check_availability",
                "args": ["{{ $node.receive-order.out.order_data.items }}"]
              },
              "output": {
                "all_available": "{{ $out.all_available }}",
                "unavailable_items": "{{ $out.unavailable_items }}",
                "available_items": "{{ $out.available_items }}"
              }
            },
            {
              "name": "handle-inventory",
              "switch": {
                "{{ $node.inventory-check.out.all_available == true }}": {
                  "name": "items-available",
                  "nodes": [
                    {
                      "name": "reserve-inventory",
                      "process": {
                        "name": "inventory.reserve",
                        "args": [
                          "{{ $node.inventory-check.out.available_items }}",
                          "{{ $node.receive-order.out.order_data.id }}"
                        ]
                      },
                      "output": {
                        "reservation_id": "{{ $out.reservation_id }}"
                      }
                    },
                    {
                      "name": "calculate-total",
                      "process": {
                        "name": "order.calculate_total",
                        "args": [
                          "{{ $node.inventory-check.out.available_items }}",
                          "{{ $node.receive-order.out.order_data.shipping_method }}"
                        ]
                      },
                      "output": {
                        "subtotal": "{{ $out.subtotal }}",
                        "shipping_cost": "{{ $out.shipping_cost }}",
                        "tax": "{{ $out.tax }}",
                        "total": "{{ $out.total }}",
                        "currency": "{{ $out.currency }}"
                      }
                    },
                    {
                      "name": "process-payment",
                      "prompts": [
                        {
                          "role": "system",
                          "content": "ä½ æ˜¯ä¸€ä¸ªæ”¯ä»˜å¤„ç†åŠ©æ‰‹ï¼Œè¯·ååŠ©å¤„ç†è®¢å•æ”¯ä»˜"
                        },
                        {
                          "role": "user",
                          "content": "è®¢å•ä¿¡æ¯ï¼š\nè®¢å•IDï¼š{{ $node.receive-order.out.order_data.id }}\né‡‘é¢ï¼š{{ $node.calculate-total.out.total }} {{ $node.calculate-total.out.currency }}\n\nè¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼š\n1. ä¿¡ç”¨å¡\n2. æ”¯ä»˜å®\n3. å¾®ä¿¡æ”¯ä»˜\n4. é“¶è¡Œè½¬è´¦"
                        }
                      ],
                      "ui": "cli",
                      "label": "è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼š",
                      "output": {
                        "payment_method": "{{ $out[0] }}"
                      }
                    },
                    {
                      "name": "execute-payment",
                      "process": {
                        "name": "payment.process",
                        "args": [
                          "{{ $node.calculate-total.out.total }}",
                          "{{ $node.process-payment.out.payment_method }}",
                          "{{ $node.receive-order.out.order_data }}"
                        ]
                      },
                      "output": {
                        "payment_id": "{{ $out.payment_id }}",
                        "payment_status": "{{ $out.status }}",
                        "transaction_id": "{{ $out.transaction_id }}"
                      }
                    },
                    {
                      "name": "handle-payment-result",
                      "switch": {
                        "{{ $node.execute-payment.out.payment_status == 'success' }}": {
                          "name": "payment-success",
                          "nodes": [
                            {
                              "name": "confirm-inventory-deduction",
                              "process": {
                                "name": "inventory.confirm_deduction",
                                "args": ["{{ $node.reserve-inventory.out.reservation_id }}"]
                              },
                              "output": {
                                "deduction_confirmed": "{{ $out.confirmed }}"
                              }
                            },
                            {
                              "name": "create-shipment",
                              "process": {
                                "name": "shipping.create_shipment",
                                "args": [
                                  "{{ $node.receive-order.out.order_data }}",
                                  "{{ $node.inventory-check.out.available_items }}"
                                ]
                              },
                              "output": {
                                "shipment_id": "{{ $out.shipment_id }}",
                                "tracking_number": "{{ $out.tracking_number }}",
                                "estimated_delivery": "{{ $out.estimated_delivery }}"
                              }
                            },
                            {
                              "name": "update-order-status",
                              "process": {
                                "name": "order.update_status",
                                "args": [
                                  "{{ $node.receive-order.out.order_data.id }}",
                                  "paid",
                                  {
                                    "payment_id": "{{ $node.execute-payment.out.payment_id }}",
                                    "shipment_id": "{{ $node.create-shipment.out.shipment_id }}"
                                  }
                                ]
                              },
                              "output": {
                                "order_status": "{{ $out.status }}",
                                "updated_at": "{{ $out.updated_at }}"
                              }
                            },
                            {
                              "name": "send-confirmation",
                              "process": {
                                "name": "notification.send_order_confirmation",
                                "args": [
                                  "{{ $node.receive-order.out.order_data.customer_email }}",
                                  "{{ $node.receive-order.out.order_data }}",
                                  "{{ $node.create-shipment.out }}",
                                  "{{ $node.calculate-total.out }}"
                                ]
                              },
                              "output": {
                                "notification_sent": "{{ $out.sent }}",
                                "message_id": "{{ $out.message_id }}"
                              }
                            },
                            {
                              "name": "show-order-success",
                              "ui": "cli",
                              "label": "è®¢å•å¤„ç†æˆåŠŸï¼",
                              "autofill": {
                                "value": "ğŸ›’ è®¢å•å¤„ç†æˆåŠŸï¼\n\nè®¢å•å·ï¼š{{ $node.receive-order.out.order_data.id }}\næ”¯ä»˜é‡‘é¢ï¼š{{ $node.calculate-total.out.total }} {{ $node.calculate-total.out.currency }}\næ”¯ä»˜æ–¹å¼ï¼š{{ $node.process-payment.out.payment_method }}\näº¤æ˜“å·ï¼š{{ $node.execute-payment.out.transaction_id }}\n\nğŸ“¦ å‘è´§ä¿¡æ¯ï¼š\nå‘è´§å•å·ï¼š{{ $node.create-shipment.out.shipment_id }}\nå¿«é€’å•å·ï¼š{{ $node.create-shipment.out.tracking_number }}\né¢„è®¡é€è¾¾ï¼š{{ $node.create-shipment.out.estimated_delivery }}\n\nğŸ“§ ç¡®è®¤é‚®ä»¶å·²å‘é€è‡³ï¼š{{ $node.receive-order.out.order_data.customer_email }}\n\næ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼",
                                "action": "exit"
                              }
                            }
                          ]
                        },
                        "default": {
                          "name": "payment-failed",
                          "nodes": [
                            {
                              "name": "release-inventory",
                              "process": {
                                "name": "inventory.release",
                                "args": ["{{ $node.reserve-inventory.out.reservation_id }}"]
                              }
                            },
                            {
                              "name": "update-payment-failed",
                              "process": {
                                "name": "order.update_status",
                                "args": [
                                  "{{ $node.receive-order.out.order_data.id }}",
                                  "payment_failed",
                                  {
                                    "payment_error": "{{ $node.execute-payment.out.payment_status }}"
                                  }
                                ]
                              },
                              "output": {
                                "order_status": "{{ $out.status }}"
                              }
                            },
                            {
                              "name": "show-payment-error",
                              "ui": "cli",
                              "label": "æ”¯ä»˜å¤±è´¥ï¼š",
                              "autofill": {
                                "value": "âŒ æ”¯ä»˜å¤±è´¥\n\né”™è¯¯åŸå› ï¼š{{ $node.execute-payment.out.payment_status }}\nè®¢å•çŠ¶æ€ï¼š{{ $node.update-payment-failed.out.order_status }}\n\nåº“å­˜å·²é‡Šæ”¾ï¼Œæ‚¨å¯ä»¥é‡æ–°å°è¯•æ”¯ä»˜ã€‚",
                                "action": "exit"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ]
                },
                "default": {
                  "name": "items-unavailable",
                  "nodes": [
                    {
                      "name": "show-inventory-error",
                      "ui": "cli",
                      "label": "åº“å­˜ä¸è¶³ï¼š",
                      "autofill": {
                        "value": "âŒ åº“å­˜ä¸è¶³\n\nä»¥ä¸‹å•†å“åº“å­˜ä¸è¶³ï¼š\n{{ join($node.inventory-check.out.unavailable_items, '\\n') }}\n\nå¯è´­ä¹°å•†å“ï¼š\n{{ join($node.inventory-check.out.available_items.map(#item => `${#item.name} x ${#item.quantity}`), '\\n') }}\n\nè¯·è°ƒæ•´è®¢å•åé‡æ–°æäº¤ã€‚",
                        "action": "exit"
                      }
                    }
                  ]
                }
              }
            }
          ]
        },
        "default": {
          "name": "invalid-order",
          "nodes": [
            {
              "name": "show-validation-error",
              "ui": "cli",
              "label": "è®¢å•éªŒè¯å¤±è´¥ï¼š",
              "autofill": {
                "value": "âŒ è®¢å•éªŒè¯å¤±è´¥\n\né”™è¯¯ä¿¡æ¯ï¼š\n{{ join($node.receive-order.out.errors, '\\n') }}\n\nè¯·æ£€æŸ¥è®¢å•ä¿¡æ¯åé‡æ–°æäº¤ã€‚",
                "action": "exit"
              }
            }
          ]
        }
      }
    }
  ],
  "output": {
    "order_result": "{{ $node.receive-order.out.is_valid ? ($node.handle-inventory.out.valid-order != null ? ($node.handle-inventory.out.valid-order.items-available != null ? ($node.handle-inventory.out.valid-order.items-available.handle-payment-result.out.payment-success != null ? { \"status\": \"success\", \"order_id\": $node.receive-order.out.order_data.id, \"shipment_id\": $node.create-shipment.out.shipment_id } : { \"status\": \"payment_failed\", \"order_id\": $node.receive-order.out.order_data.id }) : { \"status\": \"inventory_unavailable\", \"unavailable_items\": $node.inventory-check.out.unavailable_items }) : { \"status\": \"invalid_order\", \"errors\": $node.receive-order.out.errors }) : { \"status\": \"invalid_order\", \"errors\": $node.receive-order.out.errors }}",
    "processing_summary": {
      "started_at": "{{ now() }}",
      "session_id": "{{ $sid }}",
      "order_id": "{{ $node.receive-order.out.order_data.id ?? 'N/A' }}"
    }
  }
}
