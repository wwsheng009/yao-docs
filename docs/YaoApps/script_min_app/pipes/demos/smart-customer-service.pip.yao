{
  "name": "smart-customer-service",
  "label": "å¤šè¯­è¨€æ™ºèƒ½å®¢æœ",
  "description": "åŸºäº AI çš„æ™ºèƒ½å®¢æœç³»ç»Ÿï¼Œæ”¯æŒå¤šè¯­è¨€å’Œå¤šç§æœåŠ¡ç±»å‹",
  "whitelist": [
    "ai.*",
    "customer.*",
    "knowledge.*",
    "translation.*",
    "ticket.*"
  ],
  "nodes": [
    {
      "name": "welcome",
      "ui": "cli",
      "label": "ğŸ¤– æ™ºèƒ½å®¢æœç³»ç»Ÿ\n\nè¯·é€‰æ‹©æœåŠ¡ç±»å‹ï¼š\n1. äº§å“å’¨è¯¢\n2. æŠ€æœ¯æ”¯æŒ\n3. è®¢å•é—®é¢˜\n4. è´¦æˆ·é—®é¢˜\n5. æŠ•è¯‰å»ºè®®\n0. äººå·¥å®¢æœ\n\nè¯·è¾“å…¥æ•°å­—é€‰æ‹©ï¼š",
      "output": {
        "service_type": "{{ $out[0] }}"
      }
    },
    {
      "name": "language-setup",
      "ui": "cli",
      "label": "ğŸŒ è¯­è¨€è®¾ç½® / Language\n\nè¯·é€‰æ‹©è¯­è¨€ / Please select languageï¼š\n1. ä¸­æ–‡\n2. English\n3. æ—¥æœ¬èª\n4. FranÃ§ais\n5. EspaÃ±ol\n\nè¯·è¾“å…¥æ•°å­—é€‰æ‹©ï¼š",
      "output": {
        "language_code": "{{ $out[0] == '1' ? 'zh' : ($out[0] == '2' ? 'en' : ($out[0] == '3' ? 'ja' : ($out[0] == '4' ? 'fr' : 'es'))) }}",
        "language_name": "{{ $out[0] == '1' ? 'ä¸­æ–‡' : ($out[0] == '2' ? 'English' : ($out[0] == '3' ? 'æ—¥æœ¬èª' : ($out[0] == '4' ? 'FranÃ§ais' : 'EspaÃ±ol'))) }}"
      }
    },
    {
      "name": "get-user-info",
      "ui": "cli",
      "label": "ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯\n\nè¯·è¾“å…¥æ‚¨çš„é‚®ç®±æˆ–æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰ï¼š",
      "output": {
        "user_contact": "{{ $out[0] }}"
      }
    },
    {
      "name": "lookup-user-history",
      "case": {
        "{{ $node.get-user-info.out.user_contact != null and $node.get-user-info.out.user_contact != '' }}": {
          "name": "has-contact",
          "nodes": [
            {
              "name": "search-user",
              "process": {
                "name": "customer.search_by_contact",
                "args": ["{{ $node.get-user-info.out.user_contact }}"]
              },
              "output": {
                "user_found": "{{ $out.found }}",
                "user_data": "{{ $out.user_data }}",
                "recent_tickets": "{{ $out.recent_tickets }}"
              }
            }
          ]
        },
        "default": {
          "name": "no-contact",
          "output": {
            "user_found": false,
            "user_data": {},
            "recent_tickets": []
          }
        }
      }
    },
    {
      "name": "main-dialog",
      "case": {
        "{{ $node.welcome.out.service_type == '5' }}": {
          "name": "human-agent",
          "nodes": [
            {
              "name": "transfer-to-human",
              "ui": "cli",
              "label": "ğŸ“ æ­£åœ¨ä¸ºæ‚¨è½¬æ¥äººå·¥å®¢æœ...\n\né¢„è®¡ç­‰å¾…æ—¶é—´ï¼š3-5åˆ†é’Ÿ\nè¯·ä¿æŒåœ¨çº¿ï¼Œå®¢æœäººå‘˜å°†å°½å¿«ä¸ºæ‚¨æœåŠ¡ã€‚",
              "autofill": {
                "value": "ğŸ« äººå·¥å®¢æœè¯·æ±‚å·²åˆ›å»º\nå·¥å•å·ï¼š{{ now().Unix() }}\nç­‰å¾…ä½ç½®ï¼šé˜Ÿåˆ—ç¬¬{{ $global.queue_position ?? 3 }}ä½\n\nå¦‚éœ€ç´§æ€¥æœåŠ¡ï¼Œè¯·æ‹¨æ‰“å®¢æœçƒ­çº¿ï¼š400-123-4567",
                "action": "exit"
              }
            }
          ]
        },
        "default": {
          "name": "ai-service",
          "nodes": [
            {
              "name": "get-problem-description",
              "ui": "cli",
              "label": "ğŸ’¬ è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜ï¼š\n\nï¼ˆæ”¯æŒæ–‡å­—è¾“å…¥ï¼Œå»ºè®®åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼‰\nâ€¢ é—®é¢˜å‘ç”Ÿçš„å…·ä½“æ—¶é—´\nâ€¢ ç›¸å…³çš„äº§å“æˆ–æœåŠ¡åç§°\nâ€¢ é—®é¢˜ç°è±¡çš„è¯¦ç»†æè¿°\nâ€¢ æ‚¨æœŸæœ›çš„è§£å†³æ–¹æ¡ˆ",
              "output": {
                "problem_description": "{{ $out[0] }}"
              }
            },
            {
              "name": "ai-analysis",
              "prompts": [
                {
                  "role": "system",
                  "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIå®¢æœåŠ©æ‰‹ï¼Œè¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ä¿¡æ¯è¿›è¡Œåˆ†æå’Œå›å¤ã€‚\n\nå½“å‰æœåŠ¡ç±»å‹ï¼š{{ $node.welcome.out.service_type == '1' ? 'äº§å“å’¨è¯¢' : ($node.welcome.out.service_type == '2' ? 'æŠ€æœ¯æ”¯æŒ' : ($node.welcome.out.service_type == '3' ? 'è®¢å•é—®é¢˜' : ($node.welcome.out.service_type == '4' ? 'è´¦æˆ·é—®é¢˜' : 'å…¶ä»–'))) }}\nç”¨æˆ·è¯­è¨€ï¼š{{ $node.language-setup.out.language_name }}\n\n{{ $node.lookup-user-history.out.user_found == true ? `ç”¨æˆ·å†å²ä¿¡æ¯ï¼š${$json($node.lookup-user-history.out.user_data)} æœ€è¿‘å·¥å•ï¼š${$json($node.lookup-user-history.out.recent_tickets)}` : 'æ–°ç”¨æˆ·' }}\n\nå›å¤è¦æ±‚ï¼š\n1. ä½¿ç”¨{{ $node.language-setup.out.language_name }}å›å¤\n2. è¯­æ°”å‹å¥½ä¸“ä¸š\n3. é’ˆå¯¹å…·ä½“é—®é¢˜æä¾›è§£å†³æ–¹æ¡ˆ\n4. å¦‚æœæ— æ³•è§£å†³ï¼Œå»ºè®®å‡çº§åˆ°äººå·¥å®¢æœ\n5. æä¾›ç›¸å…³çš„å¸®åŠ©é“¾æ¥æˆ–è”ç³»æ–¹å¼"
                },
                {
                  "role": "user",
                  "content": "æœåŠ¡ç±»å‹ï¼š{{ $node.welcome.out.service_type }}\nç”¨æˆ·è”ç³»æ–¹å¼ï¼š{{ $node.get-user-info.out.user_contact ?? 'æœªæä¾›' }}\né—®é¢˜æè¿°ï¼š{{ $node.get-problem-description.out.problem_description }}\n\nè¯·åˆ†æå¹¶å›å¤ã€‚"
                }
              ],
              "connector": "deepseek-chat",
              "options": {
                "temperature": 0.3,
                "max_tokens": 1500
              },
              "output": {
                "ai_response": "{{ $out.choices[0].message.content }}",
                "analysis_result": "{{ $out.choices[0].message.content }}"
              }
            },
            {
              "name": "knowledge-search",
              "process": {
                "name": "knowledge.search",
                "args": [
                  "{{ $node.get-problem-description.out.problem_description }}",
                  "{{ $node.language-setup.out.language_code }}",
                  "{{ $node.welcome.out.service_type }}"
                ]
              },
              "output": {
                "knowledge_results": "{{ $out.results }}",
                "relevant_articles": "{{ $out.articles }}"
              }
            },
            {
              "name": "enhanced-response",
              "prompts": [
                {
                  "role": "system",
                  "content": "åŸºäºAIåˆ†æå’ŒçŸ¥è¯†åº“æŸ¥è¯¢ç»“æœï¼Œç”Ÿæˆæ›´å‡†ç¡®å’Œè¯¦ç»†çš„å›å¤ã€‚\n\nAIåˆ†æï¼š{{ $node.ai-analysis.out.ai_response }}\nçŸ¥è¯†åº“ç»“æœï¼š{{ $json($node.knowledge-search.out.knowledge_results) }}\n\nè¯·ç”Ÿæˆæœ€ç»ˆçš„å®¢æœå›å¤ï¼ŒåŒ…å«ï¼š\n1. é—®é¢˜ç¡®è®¤å’Œç†è§£\n2. å…·ä½“è§£å†³æ–¹æ¡ˆ\n3. ç›¸å…³èµ„æºé“¾æ¥\n4. åç»­è·Ÿè¿›å»ºè®®"
                },
                {
                  "role": "assistant",
                  "content": "åŸºäºAIåˆ†æå’ŒçŸ¥è¯†åº“ï¼Œæˆ‘å°†ä¸ºæ‚¨æä¾›è¯¦ç»†çš„è§£å†³æ–¹æ¡ˆã€‚"
                }
              ],
              "connector": "deepseek-chat",
              "options": {
                "temperature": 0.2,
                "max_tokens": 2000
              },
              "output": {
                "final_response": "{{ $out.choices[0].message.content }}",
                "solution_type": "{{ $out.choices[0].message.content.contains('è§£å†³') ? 'resolved' : 'escalated' }}"
              }
            },
            {
              "name": "show-response",
              "ui": "cli",
              "label": "ğŸ¤– AIå®¢æœå›å¤",
              "autofill": {
                "value": "{{ $node.enhanced-response.out.final_response }}\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ“Š æœåŠ¡ç»Ÿè®¡\næœåŠ¡ç±»å‹ï¼š{{ $node.welcome.out.service_type == '1' ? 'äº§å“å’¨è¯¢' : ($node.welcome.out.service_type == '2' ? 'æŠ€æœ¯æ”¯æŒ' : ($node.welcome.out.service_type == '3' ? 'è®¢å•é—®é¢˜' : ($node.welcome.out.service_type == '4' ? 'è´¦æˆ·é—®é¢˜' : 'å…¶ä»–'))) }}\nå¤„ç†æ—¶é—´ï¼š{{ now().Format('15:04:05') }}\nè¯­è¨€ï¼š{{ $node.language-setup.out.language_name }}\n\n{{ $node.enhanced-response.out.solution_type == 'escalated' ? 'âš ï¸ å¦‚éœ€è¿›ä¸€æ­¥ååŠ©ï¼Œè¯·å›å¤ \"è½¬äººå·¥\" è”ç³»äººå·¥å®¢æœã€‚' : 'âœ… é—®é¢˜å·²è§£å†³ï¼Œå¦‚è¿˜æœ‰ç–‘é—®è¯·ç»§ç»­æé—®ã€‚' }}",
                "action": "exit"
              }
            }
          ]
        }
      }
    },
    {
      "name": "create-service-record",
      "process": {
        "name": "ticket.create",
        "args": [
          "{{ $node.get-user-info.out.user_contact }}",
          "{{ $node.welcome.out.service_type }}",
          "{{ $node.get-problem-description.out.problem_description }}",
          "{{ $node.enhanced-response.out.final_response }}",
          {
            "language": "{{ $node.language-setup.out.language_code }}",
            "user_found": "{{ $node.lookup-user-history.out.user_found }}",
            "ai_response": "{{ $node.ai-analysis.out.ai_response }}",
            "knowledge_used": "{{ $node.knowledge-search.out.knowledge_results }}"
          }
        ]
      },
      "output": {
        "ticket_id": "{{ $out.ticket_id }}",
        "created_at": "{{ $out.created_at }}"
      }
    }
  ],
  "output": {
    "service_result": {
      "service_type": "{{ $node.welcome.out.service_type }}",
      "language": "{{ $node.language-setup.out.language_code }}",
      "user_contact": "{{ $node.get-user-info.out.user_contact }}",
      "problem_description": "{{ $node.get-problem-description.out.problem_description }}",
      "ai_response": "{{ $node.enhanced-response.out.final_response }}",
      "solution_type": "{{ $node.enhanced-response.out.solution_type }}",
      "ticket_id": "{{ $node.create-service-record.out.ticket_id }}"
    },
    "session_summary": {
      "session_id": "{{ $sid }}",
      "start_time": "{{ now() }}",
      "user_found": "{{ $node.lookup-user-history.out.user_found }}",
      "knowledge_search_results": "{{ $node.knowledge-search.out.knowledge_results }}"
    }
  }
}
