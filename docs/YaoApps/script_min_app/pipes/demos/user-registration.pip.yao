{
  "name": "user-registration",
  "label": "ç”¨æˆ·æ³¨å†Œæµç¨‹",
  "description": "å®Œæ•´çš„ç”¨æˆ·æ³¨å†Œæµç¨‹ï¼ŒåŒ…æ‹¬éªŒè¯ã€åˆ›å»ºå’Œé€šçŸ¥",
  "whitelist": [
    "user.*",
    "validation.*",
    "notification.*",
    "security.*"
  ],
  "nodes": [
    {
      "name": "collect-user-info",
      "ui": "cli",
      "label": "è¯·è¾“å…¥ç”¨æˆ·ä¿¡æ¯ï¼ˆæ ¼å¼ï¼šé‚®ç®±,ç”¨æˆ·å,å¯†ç ï¼‰ï¼š"
    },
    {
      "name": "parse-input",
      "process": {
        "name": "utils.parse_user_input",
        "args": ["{{ $in[0] }}"]
      },
      "output": {
        "email": "{{ $out.email }}",
        "username": "{{ $out.username }}",
        "password": "{{ $out.password }}"
      }
    },
    {
      "name": "validate-input",
      "process": {
        "name": "validation.comprehensive",
        "args": [
          "{{ $node.parse-input.out }}",
          {
            "email": {
              "required": true,
              "pattern": "^[^@]+@[^@]+\\.[^@]+$"
            },
            "username": {
              "required": true,
              "min_length": 3,
              "max_length": 20,
              "pattern": "^[a-zA-Z0-9_]+$"
            },
            "password": {
              "required": true,
              "min_length": 8,
              "complexity": true
            }
          }
        ]
      },
      "output": {
        "is_valid": "{{ $out.valid }}",
        "errors": "{{ $out.errors }}",
        "cleaned_data": "{{ $out.cleaned }}"
      }
    },
    {
      "name": "handle-validation",
      "case": {
        "{{ $node.validate-input.out.is_valid == true }}": {
          "name": "valid-input",
          "nodes": [
            {
              "name": "check-email-unique",
              "process": {
                "name": "user.check_email_unique",
                "args": ["{{ $node.validate-input.out.cleaned_data.email }}"]
              },
              "output": {
                "email_available": "{{ $out.available }}"
              }
            },
            {
              "name": "check-username-unique",
              "process": {
                "name": "user.check_username_unique",
                "args": ["{{ $node.validate-input.out.cleaned_data.username }}"]
              },
              "output": {
                "username_available": "{{ $out.available }}"
              }
            },
            {
              "name": "handle-uniqueness",
              "case": {
                "{{ $node.check-email-unique.out.email_available == true and $node.check-username-unique.out.username_available == true }}": {
                  "name": "unique-data",
                  "nodes": [
                    {
                      "name": "hash-password",
                      "process": {
                        "name": "security.hash_password",
                        "args": ["{{ $node.validate-input.out.cleaned_data.password }}"]
                      },
                      "output": {
                        "hashed_password": "{{ $out.hash }}"
                      }
                    },
                    {
                      "name": "create-user",
                      "process": {
                        "name": "user.create",
                        "args": [
                          "{{ $node.validate-input.out.cleaned_data.email }}",
                          "{{ $node.validate-input.out.cleaned_data.username }}",
                          "{{ $node.hash-password.out.hashed_password }}",
                          "{{ now() }}"
                        ]
                      },
                      "output": {
                        "user_id": "{{ $out.user_id }}",
                        "user_data": "{{ $out }}"
                      }
                    },
                    {
                      "name": "generate-verification-token",
                      "process": {
                        "name": "security.generate_token",
                        "args": [
                          "{{ $node.create-user.out.user_id }}",
                          "email_verification",
                          3600
                        ]
                      },
                      "output": {
                        "token": "{{ $out.token }}",
                        "expires_at": "{{ $out.expires_at }}"
                      }
                    },
                    {
                      "name": "send-verification-email",
                      "process": {
                        "name": "notification.send_email",
                        "args": [
                          "{{ $node.validate-input.out.cleaned_data.email }}",
                          "email_verification",
                          {
                            "token": "{{ $node.generate-verification-token.out.token }}",
                            "username": "{{ $node.validate-input.out.cleaned_data.username }}",
                            "expires_at": "{{ $node.generate-verification-token.out.expires_at }}"
                          }
                        ]
                      },
                      "output": {
                        "email_sent": "{{ $out.sent }}",
                        "message_id": "{{ $out.message_id }}"
                      }
                    },
                    {
                      "name": "show-success",
                      "ui": "cli",
                      "label": "æ³¨å†ŒæˆåŠŸï¼",
                      "autofill": {
                        "value": "ğŸ‰ æ³¨å†ŒæˆåŠŸï¼\n\nç”¨æˆ·IDï¼š{{ $node.create-user.out.user_id }}\nç”¨æˆ·åï¼š{{ $node.validate-input.out.cleaned_data.username }}\né‚®ç®±ï¼š{{ $node.validate-input.out.cleaned_data.email }}\n\nğŸ“§ éªŒè¯é‚®ä»¶å·²å‘é€ï¼Œè¯·æ£€æŸ¥é‚®ç®±å¹¶ç‚¹å‡»é“¾æ¥æ¿€æ´»è´¦æˆ·ã€‚\néªŒè¯é“¾æ¥æœ‰æ•ˆæœŸï¼š1å°æ—¶\n\nå¦‚æœªæ”¶åˆ°é‚®ä»¶ï¼Œè¯·è”ç³»å®¢æœã€‚",
                        "action": "exit"
                      }
                    }
                  ]
                },
                "default": {
                  "name": "not-unique",
                  "nodes": [
                    {
                      "name": "show-duplicate-error",
                      "ui": "cli",
                      "label": "æ³¨å†Œå¤±è´¥ï¼š",
                      "autofill": {
                        "value": "âŒ æ³¨å†Œå¤±è´¥\n\n{{ $node.check-email-unique.out.email_available == false ? 'â€¢ è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ\\n' : '' }}{{ $node.check-username-unique.out.username_available == false ? 'â€¢ è¯¥ç”¨æˆ·åå·²è¢«ä½¿ç”¨\\n' : '' }}\n\nè¯·ä½¿ç”¨å…¶ä»–é‚®ç®±æˆ–ç”¨æˆ·åé‡æ–°æ³¨å†Œã€‚",
                        "action": "exit"
                      }
                    }
                  ]
                }
              }
            }
          ]
        },
        "default": {
          "name": "invalid-input",
          "nodes": [
            {
              "name": "show-validation-errors",
              "ui": "cli",
              "label": "è¾“å…¥éªŒè¯å¤±è´¥ï¼š",
              "autofill": {
                "value": "âŒ è¾“å…¥éªŒè¯å¤±è´¥\n\né”™è¯¯è¯¦æƒ…ï¼š\n{{ join($node.validate-input.out.errors, '\\n') }}\n\nè¯·ä¿®æ­£åé‡æ–°è¾“å…¥ã€‚\næ ¼å¼ï¼šé‚®ç®±,ç”¨æˆ·å,å¯†ç \n\nè¦æ±‚ï¼š\nâ€¢ é‚®ç®±ï¼šæœ‰æ•ˆçš„é‚®ç®±åœ°å€\nâ€¢ ç”¨æˆ·åï¼š3-20ä½å­—æ¯æ•°å­—ä¸‹åˆ’çº¿\nâ€¢ å¯†ç ï¼šè‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—",
                "action": "exit"
              }
            }
          ]
        }
      }
    }
  ],
  "output": {
    "registration_result": "{{ $node.handle-validation.out.valid-input != null ? ($node.handle-validation.out.valid-input.unique-data != null ? { \"status\": \"success\", \"user_id\": $node.create-user.out.user_id, \"email\": $node.validate-input.out.cleaned_data.email, \"message\": \"Registration successful\" } : { \"status\": \"failed\", \"reason\": \"duplicate\", \"message\": \"Email or username already exists\" }) : { \"status\": \"failed\", \"reason\": \"validation_error\", \"errors\": $node.validate-input.out.errors }}",
    "timestamp": "{{ now() }}",
    "session_id": "{{ $sid }}"
  }
}
