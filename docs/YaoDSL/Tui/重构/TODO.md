基于上述设计的消息处理机制与重构思路，以下是为 `yao/tui` 项目量身定制的 `REFACTOR_TODO.md` 文档。这份文档参考了 Windows 消息分发和最优工程实践，旨在解决消息冲突并增强 TUI 的可扩展性。

---

# Yao TUI 消息循环与组件状态管理重构计划

## 🎯 目标

- **消除冲突**：解决全局按键与组件输入、多组件同时响应消息的冲突问题。
- **职责清晰**：建立类似 Windows WndProc 的“捕获-分发-冒泡”机制。
- **高扩展性**：支持 CRUD 等复杂复合组件的内部状态机切换。
- **异步集成**：优雅地支持 V8 引擎/外部 Process 触发的异步 UI 更新。

---

## 📅 重构任务清单

### Phase 1: 基础设施重构 (Core Infrastructure)

- [ ] **定义响应类型 (`Response`)**：在 `tui/types.go` 中引入枚举。
- `Ignored`: 消息未处理，继续传递给兄弟/父组件。
- `Handled`: 消息已处理，截断传递链。
- `Broadcast`: 消息已处理，但仍允许全局广播。

- [ ] **升级组件接口 (`Component`)**：
- 修改 `Update(msg tea.Msg) (tea.Model, tea.Cmd)` 为 `UpdateMsg(msg tea.Msg) (Component, tea.Cmd, Response)`。

- [ ] **实现唯一标识符 (`UID`)**：
- 为每个组件实例分配 UID，用于实现 `TargetedMsg` 的精准投递。

### Phase 2: 调度中心重构 (The Dispatcher)

- [ ] **重构 `MainModel.Update**`：
- [ ] **Capture 层**：拦截系统级快捷键（Ctrl+C, Ctrl+R 等）。
- [ ] **Dispatch 层**：根据 `FocusManager` 的状态，优先将消息发送给当前 `Focused` 组件。
- [ ] **Bubble 层**：如果 Dispatch 返回 `Ignored`，则执行全局通用逻辑。

- [ ] **引入焦点管理器 (`FocusManager`)**：
- 维护组件焦点栈。
- 实现 `Tab` 键自动导航逻辑。
- 提供组件级的 `SetFocus(bool)` 钩子。

### Phase 3: 消息隔离与命名空间 (Namespace Isolation)

- [ ] **实现消息包装器 (`TargetedMsg`)**：

```go
type TargetedMsg struct { TargetID string; InnerMsg tea.Msg }

```

- [ ] **重构基础组件**：
- 更新 `input.go`, `table.go`, `form.go` 支持 `TargetedMsg` 解包逻辑。

- [ ] **防冲突测试**：编写集成测试，验证两个独立的 `Table` 组件在同一视图下不会因同一条“行选择”消息而同时响应。

### Phase 4: 复合组件增强 (CRUD & Complex Components)

- [ ] **设计 CRUD 状态机**：
- 定义 `StateList`, `StateEditing`, `StateFiltering` 内部状态。

- [ ] **实现子消息路由**：
- 在 CRUD 组件内部根据状态转发消息给内嵌的 `Table` 或 `Form`。

- [ ] **开发事件总线 (`EventBus`)**：
- 允许子组件通过发送 `ActionMsg` 触发父组件的状态转换（如 Form 保存成功后通知 CRUD 刷新 Table）。

### Phase 5: 异步与外部桥接 (V8 & Process Integration)

- [ ] **建立外部消息通道 (`Bridge`)**：
- 在 `MainModel` 启动时初始化一个 `chan tea.Msg`。

- [ ] **V8 回调集成**：
- 封装 `v8go` 调用，使脚本执行结果能够封装成 `tea.Msg` 压入通道。

- [ ] **性能优化**：
- 针对大量异步消息（如日志流）实现消息节流（Throttling）机制。

---

## 🛠 设计规范 (Guidelines)

1. **优先级原则**：

- 全局拦截 (System) > 焦点组件 (Focused) > 非焦点订阅者 (Subscribed) > 广播消息 (Broadcast)。

2. **状态更新**：

- 禁止在组件外部强行修改组件内部状态，必须通过 `UpdateMsg` 发送特定消息。

3. **视图分离**：

- 组件的 `View()` 函数必须是纯函数，所有的布局计算应在接收到 `tea.WindowSizeMsg` 时在 `UpdateMsg` 中完成。

4. **代码格式**：

- 必须通过 `gofmt` 校验，并遵循 `yao` 项目的模块化规范。

---

## 📝 备注

_本次重构需保持对现有 Yao DSL 的兼容性，确保 `tui.yao` 的配置能够无缝映射到新的消息分发模型中。_

---

_Generated by Gemini for Yao Project - TUI Refactoring Suite_
