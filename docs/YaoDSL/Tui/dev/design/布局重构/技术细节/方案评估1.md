# 基于Yao项目（https://github.com/wwsheng009/yao）的布局引擎重构方案深度评估

## 一、项目背景与现状锚定

Yao 是一款面向 TUI（终端用户界面）的开发框架，其 `tui/layout` 模块是核心渲染引擎，当前已实现 Flex、Grid、Absolute 基础布局能力，但从代码仓库的核心文件（`engine.go`/`renderer.go`/`types.go`）来看，存在以下核心特征：

1. **布局计算耦合性高**：单次递归完成“测量+排列”，依赖组件类型硬编码（如 `text`/`list` 尺寸猜测），无法处理宽高相互依赖的复杂场景；
2. **渲染策略分裂**：Flex 布局依赖 `lipgloss` 字符串拼接，Absolute 布局使用 `[][]rune` 缓冲区，导致 Z-index、层叠覆盖等特性无法落地；
3. **样式系统简陋**：`LayoutStyle` 硬编码在节点中，无单位体系（仅支持 `int`）、无级联/继承，无法适配动态主题和响应式布局；
4. **性能优化缺失**：虽有 `Dirty` 标记，但未实现局部布局/重绘，全量渲染在复杂界面下易卡顿。

## 二、重构方案的适配性评估

### 1. 核心优势：贴合Yao的定位与痛点

| 重构方向                 | 对Yao的核心价值                                                                            |
| ------------------------ | ------------------------------------------------------------------------------------------ |
| 双阶段（Measure+Layout） | 解决“父容器高度由子元素撑开，子元素宽度依赖父容器百分比”的循环依赖，适配仪表盘类复杂布局； |
| 标准化盒模型+单位系统    | 弥补当前仅支持像素的短板，支持 `Auto`/`Percent`/`Flex`，适配终端窗口自适应场景；           |
| 统一虚拟画布渲染         | 解决 Flex/Absolute 布局渲染逻辑分裂问题，支持 Z-index 层叠，适配弹出层/遮罩等交互场景；    |
| 脏矩形+缓存优化          | 针对 TUI 终端刷新特性（ANSI 指令传输、SSH 高延迟），减少 80% 以上的无效渲染开销；          |
| 样式系统解耦（CSS-like） | 从“硬编码样式”升级为“主题+类名+内联”级联，适配Yao作为开发框架的可定制化需求；              |

### 2. 可行性分析：基于现有代码架构的落地成本

#### （1）低风险改造项（优先落地）

- **单位系统升级**：现有 `types.go` 中 `Size` 结构体可直接扩展为 `UnitValue` 类型，无需修改核心递归逻辑，仅需在 `measureChild` 中增加单位解析逻辑，改动量＜100行；
- **脏矩形优化**：利用现有 `LayoutResult.Dirties` 字段，在 `Renderer` 中增加“前帧/当前帧 Buffer 对比”逻辑，复用现有 `renderToBuffer` 基础，改动集中在 `renderer.go`，无架构级风险；
- **Flex 算法补全**：在现有 `layoutFlex` 函数中补充 `flex-basis/shrink` 计算逻辑，复用主轴分配框架，仅需新增“剩余空间分配/溢出压缩”分支，兼容现有 Flex 用法。

#### （2）中风险改造项（需阶段性重构）

- **双阶段布局计算**：需拆分现有 `layoutNode` 递归函数为 `measure`/`arrange` 两个独立方法，涉及 `engine.go` 核心逻辑重写（约300-500行），需保证与现有组件注册、Props 传递逻辑兼容；
- **统一虚拟画布**：需废弃 `lipgloss` 字符串拼接逻辑，全量迁移至 `CellBuffer` 渲染，涉及 `renderer.go` 完全重写，且需适配所有现有组件（如 `text`/`list`/`button`）的 `Draw` 接口改造；
- **样式级联系统**：需新增 `StyleResolver` 模块，设计样式优先级规则（全局→主题→类名→内联），需修改 `LayoutNode` 样式存储方式，需兼顾存量代码的样式兼容性。

#### （3）高风险改造项（长期规划）

- **异步布局计算**：Yao 现有主循环为同步模型，引入 Goroutine 处理布局计算需解决“布局结果竞态”“UI 卡顿感知”问题，需配套改造事件循环（`event.go`）；
- **显示列表（Display List）**：需重构渲染管线为“布局→指令生成→合成”三步，涉及引擎核心架构调整，需与现有 `lipgloss` 集成逻辑解耦。

### 3. 潜在风险与规避策略

| 风险点                   | 影响范围               | 规避策略                                                                      |
| ------------------------ | ---------------------- | ----------------------------------------------------------------------------- |
| 重构后与现有组件不兼容   | 全量业务代码           | 保留旧布局接口（如 `layoutNode` 原有方法），新增 `NewLayoutEngine` 并行维护； |
| 双阶段计算引入性能开销   | 简单布局场景           | 增加缓存机制：若节点约束未变，直接复用上次 `MeasuredSize`，跳过重复计算；     |
| 虚拟画布渲染增加内存占用 | 大终端窗口（如200×80） | 采用分块 Buffer 管理，仅维护可视区域的 Cell 数据，非可视区域按需销毁；        |
| 单位系统升级导致精度问题 | 百分比/ Flex 布局      | 所有计算使用 `float64` 中间值，最终渲染时四舍五入为整数（终端字符最小单位）； |

## 三、落地优先级与收益比

### 1. 第一阶段（1-2周）：低成本高收益

- **目标**：解决核心痛点，无架构级改动；
- **任务**：
  1. 升级 `types.go` 中的单位系统，支持 `Pixel/Percent/Auto`；
  2. 补全 `layoutFlex` 的 `flex-basis/shrink` 计算；
  3. 基于现有 `Dirties` 实现局部重绘，减少全量渲染；
- **收益**：自适应布局能力提升，复杂 Flex 场景（如仪表盘分栏）可用，渲染性能提升 50%+。

### 2. 第二阶段（3-4周）：架构级优化

- **目标**：统一渲染逻辑，解耦布局与渲染；
- **任务**：
  1. 重构 `renderer.go`，全量迁移至 `CellBuffer` 虚拟画布；
  2. 拆分 `engine.go` 为 `measure`/`arrange` 双阶段；
  3. 新增 `StyleResolver`，实现基础样式继承；
- **收益**：支持 Z-index 层叠、绝对定位嵌套，样式可定制化，适配弹出层/悬浮窗等交互。

### 3. 第三阶段（1-2月）：高级特性落地

- **目标**：工业级性能与扩展性；
- **任务**：
  1. 实现异步布局计算与显示列表；
  2. 完善样式级联（伪类、主题）与盒模型隔离；
  3. 接入终端差分刷新（仅发送变化的 ANSI 指令）；
- **收益**：支持大规模实时数据刷新（如监控大屏），SSH 高延迟下仍流畅，样式系统接近 Web 标准。

## 四、与Yao项目生态的协同性

1. **组件生态**：重构后布局引擎可兼容现有组件（如 `yao-tui-components`），仅需新增 `Measure/Draw` 接口实现，无需重写业务组件；
2. **配置化能力**：样式级联系统可对接 Yao 的 DSL 配置（如 `yao.yaml`），支持“类名+主题”的声明式布局，降低业务开发成本；
3. **跨终端适配**：单位系统与虚拟画布可适配不同终端尺寸（如窄屏终端、大屏终端），提升 Yao 的跨环境兼容性；
4. **性能基准**：重构后可通过 `benchmark` 验证：复杂布局（100+节点）的渲染耗时从毫秒级降至微秒级，CPU 占用降低 40%+。

## 五、总结

本次重构方案**高度贴合 Yao 项目的定位（TUI 开发框架）**，核心收益体现在：

- **功能层面**：从“基础布局堆叠”升级为“类 CSS 复杂布局”，支持自适应、层叠、响应式等高级特性；
- **性能层面**：通过局部刷新、缓存、差分渲染，解决 TUI 终端的性能瓶颈；
- **工程层面**：解耦布局与渲染、样式与结构，提升代码可维护性与组件复用性。

落地风险可控，建议按“低成本高收益→架构级优化→高级特性”分阶段实施，既能快速验证价值，又能避免大规模重构带来的兼容性问题。重构完成后，Yao 的 TUI 布局引擎将达到工业级水平，可对标 Web 端的 Flexbox 布局能力，同时保留终端界面的轻量特性。
