# å¿«æ·é”®å¤„ç†æœºåˆ¶å®¡æŸ¥æ‰§è¡Œæ‘˜è¦

## å®¡æŸ¥æ—¶é—´

2026-01-19

## å®¡æŸ¥èŒƒå›´

TUIç»„ä»¶çš„å¿«æ·é”®/æ¶ˆæ¯å¤„ç†æœºåˆ¶

## æ§åˆ¶æ–‡ä»¶ä½ç½®

- **ä¸»é€»è¾‘**: `tui/model.go` (handleKeyPress, isGlobalNavigationKey, handleGlobalNavigation,handleBoundActions)
- **é…ç½®åŠ è½½**: `tui/loader.go` (é»˜è®¤å¿«æ·é”®ç»‘å®š)
- **ç»„ä»¶å±‚**: `tui/components/*.go` (å„ç»„ä»¶çš„UpdateMsgæ–¹æ³•)

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

### 1. Tabé”®å†²çª

**é—®é¢˜**: Tabæ— æ¡ä»¶ä½œä¸ºå…¨å±€å¯¼èˆªé”®ï¼Œä¸ç»‘å®šç³»ç»Ÿå†²çª

```go
// loader.go:198
setMissingBinding(cfg.Bindings, "tab", core.Action{Process: "tui.focus.next"})  // â† å†²çª

// model.go:421
func (m *Model) isGlobalNavigationKey(msg tea.KeyMsg) bool {
    return msg.Type == tea.KeyTab ||  // â† æ— æ¡ä»¶ï¼Œè¢«å¿½ç•¥ç»‘å®š
        // ...
}
```

**å½±å“**:

- Tabæ°¸è¿œè§¦å‘ç»„ä»¶åˆ‡æ¢ï¼Œæ— æ³•è¦†ç›–
- ä¸`loader.go`ä¸­çš„é»˜è®¤ç»‘å®šå†²çª

**ä¿®å¤æ–¹æ¡ˆ**:

- ç§»é™¤loader.goä¸­çš„Tabé»˜è®¤ç»‘å®š
- æ·»åŠ NavigationModeé…ç½®ï¼ˆnative/bindableï¼‰
- åœ¨nativeæ¨¡å¼ä¸‹Tabä¸æ£€æŸ¥ç»‘å®š
- åœ¨bindableæ¨¡å¼ä¸‹Tabå¯ä»¥ç»‘å®šåˆ°å…¶ä»–æ“ä½œ

---

### 2. æ— ç„¦ç‚¹æ—¶qé”®æ— æ³•é€€å‡º

**é—®é¢˜**: qé”®ä¾èµ–`handleBoundActions`ï¼Œä½†åªåœ¨æ²¡æœ‰ç„¦ç‚¹æ—¶æ‰èƒ½åˆ°è¾¾

```go
// model.go:391-418
if m.CurrentFocus != "" {
    // åˆ†å‘ç»™ç»„ä»¶
    // å¦‚æœç»„ä»¶è¿”å›Handledï¼Œqé”®ä¼šè¢«æ‹¦æˆª
}
// åªæœ‰ç»„ä»¶è¿”å›Ignoredæ‰èƒ½åˆ°è¾¾handleBoundActions
```

**å½±å“**: è¾“å…¥ç»„ä»¶bluråä»å¯èƒ½Handledæ‰€æœ‰æŒ‰é”®

**ä¿®å¤æ–¹æ¡ˆ**: âœ…å·²å®Œæˆ

- æ‰€æœ‰è¾“å…¥ç»„ä»¶æ·»åŠ ç„¦ç‚¹çŠ¶æ€æ£€æŸ¥
- å¤±ç„¦åè¿”å›Ignored

---

## ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

### 3. ç»„ä»¶Handledåå…¨å±€å¯¼èˆªé”®ä»è§¦å‘

**é—®é¢˜**: å³ä½¿ç»„ä»¶è¿”å›Handledï¼ŒTab/ESCä»ä¼šè§¦å‘å…¨å±€æµç¨‹

```go
if handled {
    if m.isGlobalNavigationKey(msg) {
        // ç»„ä»¶å·²Handledï¼Œä½†å…¨å±€å¯¼èˆªé”®ä»ç„¶ç”Ÿæ•ˆ
        return m.handleGlobalNavigation(msg)
    }
}
```

**å½±å“**: ç»„ä»¶æ— æ³•å®Œå…¨æ§åˆ¶Tab/ESCè¡Œä¸º

**ä¿®å¤æ–¹æ¡ˆ**:

- åŒºåˆ†"å¼ºåˆ¶å…¨å±€é”®"ï¼ˆESCï¼‰å’Œ"å¯é€‰å…¨å±€é”®"ï¼ˆTabï¼‰
- åªå…è®¸ESCåœ¨ç»„ä»¶Handledåè§¦å‘å…¨å±€æµç¨‹

### 4. ç„¦ç‚¹åˆ‡æ¢æ— å¾ªç¯æ§åˆ¶

**é—®é¢˜**: Tabæ€»æ˜¯å¾ªç¯åˆ‡æ¢ï¼Œæ— æ³•ç¦ç”¨å¾ªç¯

```go
// model.go:481
nextIndex := (currentIndex + 1) % len(focusableIDs)  // â† å¼ºåˆ¶å¾ªç¯
```

**å½±å“**: åœ¨æŸäº›åœºæ™¯ä¸‹å¾ªç¯å¯èƒ½ä¸ç¬¦åˆé¢„æœŸ

**ä¿®å¤æ–¹æ¡ˆ**:

- æ·»åŠ `TabCycles`é…ç½®é€‰é¡¹
- éå¾ªç¯æ¨¡å¼ä¸‹åˆ°è¾¾è¾¹ç•Œåœæ­¢

---

## ğŸŸ¢ è½»å¾®é—®é¢˜ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

### 5. ç¼ºä¹å¿«æ·ç„¦ç‚¹åˆ‡æ¢æœºåˆ¶

**å»ºè®®**: æ·»åŠ Alt+1-9å¿«é€Ÿåˆ‡æ¢åˆ°æŒ‡å®šç»„ä»¶

### 6. ç„¦ç‚¹çŠ¶æ€ä¸ä¸€è‡´é£é™©

**å»ºè®®**: æ·»åŠ ç„¦ç‚¹çŠ¶æ€ä¸€è‡´æ€§éªŒè¯ï¼ˆè°ƒè¯•ç”¨ï¼‰

---

## ğŸ“Š å½“å‰å®ç°è¯„ä¼°

| åŠŸèƒ½           | è¯„åˆ†    | è¯´æ˜                       |
| -------------- | ------- | -------------------------- |
| Tabåˆ‡æ¢        | âš ï¸ 6/10 | æœ‰å†²çªï¼Œéœ€è¦é‡æ„           |
| Shift+Tabåˆ‡æ¢  | 7/10    | åŸºæœ¬æ­£å¸¸ï¼Œä½†ä¸Tabç»‘å®šå†²çª  |
| ESCé€€å‡ºç„¦ç‚¹    | 8/10    | å·²ä¿®å¤ï¼Œæ”¯æŒå…¨å±€ç»‘å®š       |
| qé”®é€€å‡º        | 7/10    | å·²ä¿®å¤ç„¦ç‚¹æ£€æŸ¥ï¼Œéœ€è¾¹ç•Œæµ‹è¯• |
| Ctrl+Cé€€å‡º     | 10/10   | å®Œç¾å®ç°                   |
| ç»„ä»¶ç„¦ç‚¹æ£€æŸ¥   | 9/10    | å¤§éƒ¨åˆ†ç»„ä»¶å·²ä¿®å¤           |
| æ¶ˆæ¯å¤„ç†ä¼˜å…ˆçº§ | 7/10    | æ¸…æ™°ä½†æœ‰æ”¹è¿›ç©ºé—´           |

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡é—®é¢˜

### é—®é¢˜ï¼šä¸‰å±‚æ¶ˆæ¯å¤„ç†æœºåˆ¶ä¸æ¸…æ™°

**å½“å‰å®ç°**ï¼ˆmodel.go:293-334ï¼‰:

```
1. Capture Phase: Ctrl+Cæ‹¦æˆª
2. Dispatch Phase: ç„¦ç‚¹ç»„ä»¶å¤„ç†
3. Bubble Phase: å…¨å±€å¤„ç†
```

**é—®é¢˜**:

- Dispatchå’ŒBubbleçš„ç•Œé™æ¨¡ç³Š
- å…¨å±€å¯¼èˆªé”®åœ¨ä¸¤ä¸ªé˜¶æ®µéƒ½å¯èƒ½è§¦å‘
- ç»„ä»¶Handledçš„æ¶ˆæ¯å¯èƒ½è¢«å…¨å±€å¤„ç†è¦†ç›–

---

## ğŸ”§ å®Œæ•´ä¿®å¤æ–¹æ¡ˆæ¦‚è§ˆ

### é‡æ„åçš„æŒ‰é”®å¤„ç†ä¼˜å…ˆçº§

```
ä¼˜å…ˆçº§1: ç³»ç»Ÿå¼ºåˆ¶ (Ctrl+C)
    â†“
ä¼˜å…ˆçº§2: åŠŸèƒ½é”® (F1-F12ï¼Œæ— æ¡ä»¶ç»‘å®š)
    â†“
ä¼˜å…ˆçº§3: ç„¦ç‚¹æ£€æŸ¥
    â”œâ”€ æ— ç„¦ç‚¹ â†’ è·³è¿‡ç»„ä»¶å¤„ç† â†’ ä¼˜å…ˆçº§5
    â””â”€ æœ‰ç„¦ç‚¹ â†’ ç»§ç»­
    â†“
ä¼˜å…ˆçº§4: ç»„ä»¶å¤„ç† (æœ‰ç„¦ç‚¹æ—¶)
    â”œâ”€ åˆ†å‘ç»™ç„¦ç‚¹ç»„ä»¶
    â”œâ”€ Ignored â†’ åˆ°ä¼˜å…ˆçº§5
    â””â”€ Handled â†’ æ£€æŸ¥å¼ºåˆ¶å…¨å±€é”®(ESC)
    â†“
ä¼˜å…ˆçº§5: åŸç”Ÿå¯¼èˆªé”®
    â”œâ”€ Tab â†’ æ£€æŸ¥ç»‘å®š æˆ– åŸç”Ÿå¯¼èˆª
    â”œâ”€ Shift+Tab â†’ æ£€æŸ¥ç»‘å®š æˆ– åŸç”Ÿå¯¼èˆª
    â””â”€ ESC â†’ ç‰¹æ®Šæµç¨‹ï¼ˆclearFocus + ç»‘å®šï¼‰
    â†“
ä¼˜å…ˆçº§6: å…¨å±€ç»‘å®š (å…œåº•)
    â†“
ä¼˜å…ˆçº§7: é»˜è®¤å¤„ç† (å¿½ç•¥)
```

### å…³é”®ä¿®å¤ç‚¹

#### 1. ç§»é™¤Tabé»˜è®¤ç»‘å®š

```diff
// loader.go:198
- setMissingBinding(cfg.Bindings, "tab", core.Action{Process: "tui.focus.next"})
+ // Tabä½œä¸ºåŸç”Ÿå¯¼èˆªé”®ï¼Œä¸éœ€è¦ç»‘å®š
```

#### 2. æ·»åŠ NavigationModeé…ç½®

```go
type Config struct {
    // ... ç°æœ‰å­—æ®µ

    // "native": Tabå§‹ç»ˆå¯¼èˆªï¼ˆé»˜è®¤ï¼‰
    // "bindable": Tabå¯ä»¥ç”¨ç»‘å®šè¦†ç›–
    NavigationMode string

    // Tabæ˜¯å¦å¾ªç¯åˆ‡æ¢
    TabCycles bool
}
```

#### 3. é‡æ„isGlobalNavigationKey

```go
var nativeNavigationKeys = map[tea.KeyType]bool{
    tea.KeyTab:      true,
    tea.KeyShiftTab: true,
}

func (m *Model) isGlobalNavigationKey(msg tea.KeyMsg) bool {
    // ESCåœ¨æœ‰ç„¦ç‚¹æ—¶ä½œä¸ºå…¨å±€å¯¼èˆªé”®
    if msg.Type == tea.KeyEsc && m.CurrentFocus != "" {
        return true
    }

    Tab/ShiftTabæ ¹æ®æ¨¡å¼å†³å®š
    switch m.Config.NavigationMode {
    case "native":
        return nativeNavigationKeys[msg.Type]
    case "bindable":
        return false
    default:
        return nativeNavigationKeys[msg.Type]
    }
}
```

#### 4. é‡æ„handleKeyPress

```go
func (m *Model) handleKeyPress(msg tea.KeyMsg) (tea.Model, tea.Cmd) {
    if msg.Type == tea.KeyCtrlC {
        return m, tea.Quit
    }

    // åŠŸèƒ½é”®ï¼ˆæ— æ¡ä»¶ï¼‰
    if m.isFunctionKey(msg) {
        return m.handleBoundActions(msg)
    }

    hasFocus := m.CurrentFocus != ""

    // ç»„ä»¶å¤„ç†
    if hasFocus {
        updatedModel, cmd, handled := m.dispatchMessageToComponent(m.CurrentFocus, msg)
        if handled {
            // åªå…è®¸ESCå¼ºè¡Œè§¦å‘å…¨å±€æµç¨‹
            if msg.Type == tea.KeyEsc {
                return m.handleEscWithFocus(msg)
            }
            return updatedModel, cmd
        }
        m = updatedModel.(*Model)
    }

    // åŸç”Ÿå¯¼èˆªé”®
    if m.isNativeNavigationKey(msg) {
        return m.handleNativeNavigation(msg, hasFocus)
    }

    // å…¨å±€ç»‘å®š
    return m.handleBoundActions(msg)
}
```

#### 5. åŸç”Ÿå¯¼èˆªé”®å¤„ç†

```go
func (m *Model) handleNativeNavigation(msg tea.KeyMsg, hasFocus bool) (tea.Model, tea.Cmd) {
    key := msg.String()

    switch msg.Type {
    case tea.KeyTab:
        // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ç»‘å®š
        if m.Config.Bindings != nil {
            if action, ok := m.Config.Bindings[key]; ok {
                return m.executeBoundAction(&action, key)
            }
        }
        // ç¬¬äºŒæ­¥ï¼šåŸç”Ÿå¯¼èˆª
        return m.handleTabNavigation()

    case tea.KeyShiftTab:
        // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ç»‘å®š
        if m.Config.Bindings != nil {
            if action, ok := m.Config.Bindings[key]; ok {
                return m.executeBoundAction(&action, key)
            }
        }
        // ç¬¬äºŒæ­¥ï¼šåŸç”Ÿå¯¼èˆª
        return m, tea.Cmd{func() tea.Msg {
            m.focusPrevComponent()
            return nil
        }}
    }

    return m, nil
}
```

---

## ğŸ“‹ æµ‹è¯•çŸ©é˜µï¼ˆå¿…é¡»è¦†ç›–ï¼‰

### åŸºç¡€åŠŸèƒ½

- [ ] Ctrl+Cå¼ºåˆ¶é€€å‡º
- [ ] qé”®æ— ç„¦ç‚¹æ—¶é€€å‡º
- [ ] Tabæ— ç„¦ç‚¹æ—¶èšç„¦ç¬¬ä¸€ä¸ª
- [ ] Tabæœ‰ç„¦ç‚¹æ—¶åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª
- [ ] Shift+Tabåˆ‡æ¢åˆ°ä¸Šä¸€ä¸ª
- [ ] ESCæ¸…é™¤ç„¦ç‚¹
- [ ] ESCæ‰§è¡Œå…¨å±€ç»‘å®šï¼ˆå¦‚æœæœ‰ï¼‰

### å†²çªåœºæ™¯

- [ ] Tabç»‘å®šï¼ˆnativeæ¨¡å¼ï¼‰- åº”å¿½ç•¥ç»‘å®š
- [ ] Tabç»‘å®šï¼ˆbindableæ¨¡å¼ï¼‰- åº”æ‰§è¡Œç»‘å®š
- [ ] ç»„ä»¶Handled Tab - åº”åˆ‡æ¢ç„¦ç‚¹
- [ ] ç»„ä»¶Handled å­—ç¬¦ - ä¸åº”åˆ‡æ¢ç„¦ç‚¹

### è¾¹ç•Œæ¡ä»¶

- [ ] æ— ç„¦ç‚¹ç»„ä»¶æ—¶Tab
- [ ] å•ä¸ªç»„ä»¶æ—¶Tab
- [ ] ç„¦ç‚¹ç»„ä»¶è¢«ç§»é™¤
- [ ] æ— ç„¦ç‚¹æ—¶æŒ‰q
- [ ] å¤šæ¬¡æŒ‰ESC

---

## ğŸš€ å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šç´§æ€¥ä¿®å¤ï¼ˆå¿…é¡»ï¼‰

1. âœ… ä¿®å¤è¾“å…¥ç»„ä»¶ç„¦ç‚¹æ£€æŸ¥ - å·²å®Œæˆ
2. âœ… æ·»åŠ ESCå…¨å±€ç»‘å®š - å·²å®Œæˆ
3. âš ï¸ **ç§»é™¤Tabé»˜è®¤ç»‘å®š** - å¾…å®æ–½
4. âš ï¸ **å®Œå–„ç„¦ç‚¹åˆ‡æ¢é€»è¾‘** - å¾…å®æ–½

### ç¬¬äºŒé˜¶æ®µï¼šæ¶æ„é‡æ„ï¼ˆå»ºè®®ï¼‰

5. æ·»åŠ NavigationModeé…ç½®
6. é‡æ„handleKeyPressï¼ˆæ–°ä¼˜å…ˆçº§ï¼‰
7. å®ç°handleNativeNavigation
8. æ›´æ–°æ‰€æœ‰ç»„ä»¶çš„UpdateMsgï¼ˆæ ‡å‡†åŒ–ï¼‰

### ç¬¬ä¸‰é˜¶æ®µï¼šå¢å¼ºåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

9. æ·»åŠ TabCyclesé…ç½®
10. æ·»åŠ Alt+1-9å¿«é€Ÿåˆ‡æ¢
11. æ·»åŠ ç„¦ç‚¹çŠ¶æ€éªŒè¯ï¼ˆè°ƒè¯•ï¼‰
12. å¢åŠ æ›´è¯¦ç»†çš„æ—¥å¿—

### ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•ä¸æ–‡æ¡£

13. å®Œæ•´æµ‹è¯•çŸ©é˜µéªŒè¯
14. æ›´æ–°ç”¨æˆ·æ–‡æ¡£
15. ç¼–å†™è¿ç§»æŒ‡å—
16. æ›´æ–°AGENTS.md

---

## ğŸ“Š é£é™©è¯„ä¼°

| é£é™©                    | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½               |
| ----------------------- | ------ | ---- | ---------------------- |
| Tabè¡Œä¸ºæ”¹å˜ç ´åç°æœ‰åº”ç”¨ | ä¸­     | é«˜   | ä¿ç•™nativeæ¨¡å¼ä½œä¸ºé»˜è®¤ |
| ç»„ä»¶éœ€æ›´æ–°æ‰èƒ½å…¼å®¹      | ä½     | ä¸­   | ä¿æŒç°æœ‰è¡Œä¸ºå‘åå…¼å®¹   |
| æ¶ˆæ¯æ­»å¾ªç¯              | ä½     | ä¸¥é‡ | å•å‘æ¶ˆæ¯æµé™åˆ¶         |
| ç„¦ç‚¹çŠ¶æ€ä¸ä¸€è‡´          | ä¸­     | ä¸­   | æ·»åŠ éªŒè¯æœºåˆ¶           |

---

## ğŸ“ å†³ç­–å»ºè®®

### ç«‹å³å®æ–½çš„é—®é¢˜

1. **ç§»é™¤Tabé»˜è®¤ç»‘å®š** - é¿å…æ··æ·†
2. **å®Œå–„æµ‹è¯•è¦†ç›–** - ç¡®ä¿ç¨³å®šæ€§

### å»ºè®®å®æ–½çš„åŠŸèƒ½

1. **NavigationModeé…ç½®** - æä¾›çµæ´»æ€§
2. **TabCyclesé…ç½®** - æ”¯æŒä¸åŒéœ€æ±‚

### å¯é€‰ä¼˜åŒ–

1. Alt+1-9å¿«é€Ÿåˆ‡æ¢ - æå‡æ•ˆç‡
2. ç„¦ç‚¹éªŒè¯è°ƒè¯• - æ–¹ä¾¿å¼€å‘

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

å®Œæ•´å®¡æŸ¥æŠ¥å‘Š: `tui/docs/KEY_HANDLE_MECHANISM_COMPREHENSIVE_REVIEW.md`
ESCé”®ä¿®å¤: `tui/docs/ESC_QUIT_KEY_FIX.md`
ç„¦ç‚¹ä¸Tabå¯¼èˆª: `tui/docs/FOCUS_STATE_AND_TAB_NAVIGATION_FIX.md`
ESCå…¨å±€ç»‘å®š: `tui/docs/ESC_GLOBAL_BINDING_PRIORITY.md`

---

## âœ… éªŒæ”¶æ ‡å‡†

æ‰€æœ‰ä¿®å¤å®æ–½åï¼Œå¿…é¡»æ»¡è¶³ï¼š

1. **æ— ç„¦ç‚¹æ—¶qé”®é€€å‡º** âœ“
2. **è¾“å…¥ç»„ä»¶ESCå¤±ç„¦** âœ“
3. **Tabå†²çªè§£å†³** âš ï¸
4. **ç»„ä»¶ç„¦ç‚¹æ£€æŸ¥** âœ“
5. **æ¶ˆæ¯å¤„ç†ä¼˜å…ˆçº§æ¸…æ™°** âš ï¸
6. **æµ‹è¯•100%è¦†ç›–** âš ï¸

ç¬¦å·è¯´æ˜:

- âœ… å·²å®Œæˆ
- âš ï¸ éƒ¨åˆ†å®Œæˆæˆ–å¾…å®æ–½
- âŒ æœªå¼€å§‹

---

**å®¡æŸ¥äºº**: AI Assistant
**æ—¥æœŸ**: 2026-01-19
**çŠ¶æ€**: è¿›è¡Œä¸­
