你好！我是 **Yao Dev**，高级代码开发工程师。

我们已经完成了从底层架构到组件化方案的深度设计。现在，我们将进入 **Yao TUI 引擎的“神经网络”：即：跨平台交互适配、安全沙箱集成以及最终的工程化打包方案**。这一部分将决定 TUI 引擎在生产环境中的稳定性和易用性。

以下是针对项目实施大纲的最后阶段补充：

### 1. 终端环境自适应与 Lip Gloss 主题引擎

TUI 应用在不同的终端（如 macOS Terminal, iTerm2, VSCode Terminal, xterm-256color）下表现各异。

- **自适应机制**：在 `tui/driver.go` 中集成 `term.GetSize()`，并监听 `tea.WindowSizeMsg`。当用户调整窗口大小时，递归计算所有 `flex` 布局组件的百分比宽度。
- **DSL 主题驱动**：支持在应用级别定义全局颜色变量（如 `yao.theme.json`），在 DSL 中通过样式名引用，实现一键切换“黑客绿”或“简约白”风格。

### 2. 交互安全与用户输入隔离 (Input Sandboxing)

由于 TUI 运行在服务器端终端环境，必须严格控制 Process 处理器的执行权限。

- **输入校验**：所有来自 `type: "input"` 组件的数据在通过 `{{}}` 传递给 Process 之前，必须经过 `utils.Sanitize` 过滤，防止注入攻击。
- **会话绑定**：利用 Yao 现有的 `session` 模块，将 TUI 实例与终端会话绑定。在 `onLoad` 时自动校验用户的 JWT 或权限，确保敏感数据不会在无授权终端上显示。

### 3. 工程化：Yaz 打包与分发

Yao 的优势在于一键打包，TUI 模块也应无缝集成到 `yao pack` 流程中。

- **资源嵌入 (`yaoapp/yao/data/bindata.go`)**：在编译阶段，利用 `embed` 特性将基础的 TUI 静态资源（如默认图标、样式库）打包进二进制文件。
- **分发命令**：用户只需执行 `yao tui setup` 即可在当前环境下安装所有必要的字体支持（如 Nerd Fonts，这对于美观的 TUI 界面至关重要）。

### 4. 关键实现：`tui/process.go` 处理器定义

这是将 TUI 能力暴露给 Yao 生态的核心接口代码：

```go
package tui

import (
    "github.com/yaoapp/gou/process"
    "github.com/yaoapp/yao/config"
)

// Export 注册 TUI 相关的 Process
func Export() {
    process.Register("tui.Render", ProcessRender)
    process.Register("tui.Update", ProcessUpdate)
}

// ProcessRender 渲染 TUI 界面: tui.Render("admin.user", {"id": 1})
func ProcessRender(process *process.Process) interface{} {
    id := process.ArgsString(0)
    args := process.ArgsMap(1)

    // 获取配置
    cfg, err := GetConfig(id)
    if err != nil {
        panic(err)
    }

    // 启动 Bubble Tea 程序
    m := NewModel(id, cfg, args)
    p := tea.NewProgram(m, tea.WithAltScreen())
    if _, err := p.Run(); err != nil {
        return err.Error()
    }
    return nil
}

```

### 项目总结建议：

在接下来的编码实施中，我建议你按照以下优先级执行：

1. **MVP (最小可行性产品)**：实现 `yao tui <id>` 加载一个带 `Text` 组件的静态 JSON。
2. **数据流转**：实现 `onLoad` 调用 Process 填充 `State`。
3. **交互增强**：引入 `Action` 映射和 AI 流式渲染支持。

至此，**Yao TUI 引擎设计白皮书** 已全部完成。你是否已经准备好在本地 Yao 源码中开启 `tui/` 文件夹的第一个 `commit`？或者需要我针对具体的 **AI 流式渲染中的消息分发（Message Dispatching）** 提供更硬核的并发控制代码？
