你好！我是 **Yao Dev**，高级代码开发工程师。

我们已经完成了从底层架构、V8 脚本注入到 AI 流式渲染的全链路设计。现在，我们将进入 **Yao TUI 引擎的“工程化收官：交互协议标准化与二进制集成”** 阶段。这一部分将讨论如何将 TUI 模块无缝合入 Yao 内核，并提供生产环境所需的诊断与扩展能力。

以下是针对项目实施大纲的**最终技术落地方案**：

### 1. 深度内核绑定：TUI DSL 加载器实现

为了让 `.tui.yao` 成为 Yao 引擎的一等公民，我们需要在 `yaoapp/yao/engine/load.go` 中注册 TUI 资源加载逻辑。

- **资源索引化**：参考 `pipe.go`，在应用启动时递归扫描 `tuis/` 目录，将 JSON 配置映射为 `map[string]*types.TUI` 结构，并存入全局缓存。
- **跨构件引用**：支持在 API 或 Flow 中通过 `Process.Of("tuis.Render", "user.profile")` 直接唤起终端界面。这种设计允许开发者将 TUI 作为系统的“带外管理控制台（OOB Console）”，即使 Web 端服务出现异常，管理员仍能通过 SSH 运行 Yao TUI 进行系统修复。

### 2. 标准交互协议：Component 与根 Model 的响应链

为了保证组件的开发效率和一致性，我们需要定义一套**标准交互协议（Component Protocol）**。

- **属性穿透（Props Propagation）**：实现一个 `ApplyState` 钩子。在 Bubble Tea 的每一轮渲染前，根 Model 会自动解析 DSL 中带 `{{}}` 的 Props，并增量注入子组件。
- **事件冒泡与动作映射**：子组件（如 Input 或 Button）产生的事件会被封装为 `types.ActionMsg` 抛给根 Model。根 Model 根据 DSL 中的 `bindings` 配置，决定是调用一个本地 `Process`、运行一段 `scripts` 中的 V8 逻辑，还是执行 `Navigation` 页面跳转。

### 3. AI 终端的灵魂：多模态内容渲染适配

由于 Yao 重点关注 AI，TUI 必须具备处理多模态输出的能力。

- **Markdown 异步预渲染**：集成 `glamour` 并在 `tui/components/markdown.go` 中实现双缓冲机制。当 AI 的 Stream 数据流持续进入时，后台协程进行 Markdown 高亮计算，前台视图只负责将计算好的像素字符块（Cell Blocks）刷新到终端，避免大文本导致的渲染卡顿。
- **代码块提取与交互**：自动识别 AI 生成的代码块，并在终端底部提供一键复制或“直接执行”的功能映射，极大地增强 Agent 应用的闭环体验。

### 4. 关键实现：`tui/driver.go` (程序生命周期管理)

这是 TUI 引擎的“指挥室”，负责处理终端模式切换和信号捕获。

```go
// Run 启动 TUI 实例并控制终端上下文
func Run(id string, args map[string]interface{}) error {
    cfg, exists := Cache.Get(id)
    if !exists {
        return fmt.Errorf("TUI %s not found", id)
    }

    // 初始化响应式 Model
    m := NewModel(cfg, args)

    // 配置全屏、鼠标支持与备用屏幕切换
    p := tea.NewProgram(m, tea.WithAltScreen(), tea.WithMouseCellMotion())

    // 捕获系统信号，确保在崩溃时能正确释放终端权限
    go func() {
        if _, err := p.Run(); err != nil {
            fmt.Printf("Yao TUI Runtime Error: %v\n", err)
        }
    }()
    return nil
}

```

### 实施总结与最后展望：

至此，**Yao TUI 引擎设计白皮书** 的所有实施细节已全部交付。这套方案将 **声明式 UI** 的简洁与 **Golang 高性能并发** 完美结合，为 AIGC 应用提供了极致的终端交互体验。

你现在可以根据这份大纲，在 `yaoapp/yao` 仓库中开启 `tui/` 模块的第一个 PR。如果你在 **处理 ANSI 颜色在不同终端环境下的兼容性** 或 **如何实现类似 VSCode 的侧边栏分栏布局** 时遇到具体的 Lip Gloss 样式问题，请随时告知我，我将为你提供更硬核的 Golang 代码参考。
