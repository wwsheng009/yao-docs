# Crypto 加密模块使用文档

Crypto 模块提供了常用的加密、解密、签名、验证等功能。所有功能通过 `Process` 函数调用。

## 调用方式

```javascript
// 基本调用格式
Process("crypto.处理器名称", 参数1, 参数2, ...);
```

---

## 1. Hash 哈希计算

计算字符串的哈希值。

### 可用算法

MD5, SHA1, SHA224, SHA256, SHA384, SHA512, MD5SHA1, RIPEMD160, SHA3_224, SHA3_256, SHA3_384, SHA3_512, SHA512_224, SHA512_256, BLAKE2s_256, BLAKE2b_256, BLAKE2b_384, BLAKE2b_512

### 别名

- `yao.crypto.hash` (已废弃, 兼容旧版本)
- `crypto.Hash`

### 使用示例

```javascript
// 计算MD5哈希
let md5 = Process('crypto.Hash', 'MD5', 'hello world');
// 输出: 5eb63bbb...

// 计算SHA256哈希
let sha256 = Process('crypto.Hash', 'SHA256', 'hello world');

// 计算SHA512哈希
let sha512 = Process('crypto.Hash', 'SHA512', 'hello world');
```

### 参数说明

- `Args[0]`: 算法名称 (字符串)
- `Args[1]`: 需要计算哈希的值 (字符串)

### 返回值

十六进制格式的哈希值字符串

---

## 2. HMAC 签名

计算 Keyed-Hash Message Authentication Code (HMAC)。

### 别名

- `yao.crypto.hmac` (已废弃, 兼容旧版本)
- `crypto.Hmac`

### 使用示例

```javascript
// 基本HMAC计算 (十六进制输出)
let hmac = Process('crypto.Hmac', 'SHA256', 'hello world', 'secret-key');

// 使用base64编码输出
let hmacBase64 = Process(
  'crypto.Hmac',
  'SHA256',
  'hello world',
  'secret-key',
  'base64'
);

// 其他算法
let hmacSHA1 = Process('crypto.Hmac', 'SHA1', 'message', 'key');
let hmacSHA512 = Process('crypto.Hmac', 'SHA512', 'message', 'key');
```

### 参数说明

- `Args[0]`: 哈希算法名称 (字符串)
- `Args[1]`: 需要签名的值 (字符串)
- `Args[2]`: 密钥 (字符串)
- `Args[3]`: 输出编码 (可选, 默认为hex, 可指定为 "base64")

### 返回值

HMAC签名结果字符串 (默认十六进制, 可指定base64)

---

## 3. HMAC 高级签名 (crypto.hmacwith)

支持自定义编码的高级HMAC签名,可指定key、value和output的编码格式。

### 使用示例

```javascript
// 使用默认设置
let hmac1 = Process('crypto.hmacwith', {}, 'hello world', 'secret-key');

// 指定所有编码为base64
let hmac2 = Process(
  'crypto.hmacwith',
  {
    key: 'base64',
    value: 'base64',
    output: 'base64'
  },
  'hello world',
  'secret-key'
);

// 混合编码: key用hex, value用base64, output用hex
let hmac3 = Process(
  'crypto.hmacwith',
  {
    key: 'hex',
    value: 'base64',
    output: 'hex'
  },
  'hello world',
  'secret-key'
);

// 指定不同算法
let hmac4 = Process(
  'crypto.hmacwith',
  {
    algo: 'SHA512',
    output: 'base64'
  },
  'message',
  'key'
);
```

### 参数说明

- `Args[0]`: 选项对象 (map), 包含以下可选字段:
  - `key`: 密钥编码, 可选值: "base64", "hex", 默认不编码
  - `value`: 值编码, 可选值: "base64", "hex", 默认不编码
  - `output`: 输出编码, 可选值: "base64", "hex", 默认为hex
  - `algo`: 哈希算法, 默认为 "SHA256"
- `Args[1]`: 需要签名的值 (字符串)
- `Args[2]`: 密钥 (字符串)

### 返回值

HMAC签名结果字符串

---

## 4. RSA2 签名 (crypto.rsa2sign)

使用RSA私钥对数据进行PKCS1v15签名。

### 使用示例

```javascript
// 签名并输出十六进制 (默认)
let signHex = Process(
  'crypto.rsa2sign',
  privateKey,
  'SHA256',
  'message to sign'
);

// 签名并输出base64
let signBase64 = Process(
  'crypto.rsa2sign',
  privateKey,
  'SHA256',
  'message to sign',
  'base64'
);

// 使用不同算法
let signSHA1 = Process(
  'crypto.rsa2sign',
  privateKey,
  'SHA1',
  'message',
  'base64'
);
let signSHA512 = Process(
  'crypto.rsa2sign',
  privateKey,
  'SHA512',
  'message',
  'base64'
);
```

### 参数说明

- `Args[0]`: RSA私钥 (字符串)
  - 支持PEM格式 (会自动添加header/footer)
  - 格式: `-----BEGIN RSA PRIVATE KEY-----\n...\n-----END RSA PRIVATE KEY-----`
- `Args[1]`: 哈希算法名称 (字符串)
- `Args[2]`: 需要签名的值 (字符串)
- `Args[3]`: 输出编码 (可选, 默认为hex, 可指定为 "base64")

### 返回值

签名结果字符串 (默认十六进制, 可指定base64)

---

## 5. RSA2 验证签名 (crypto.rsa2verify)

使用RSA公钥验证签名。

### 使用示例

```javascript
// 验证十六进制签名
let valid1 = Process(
  'crypto.rsa2verify',
  publicKey,
  'SHA256',
  'message to sign',
  signature
);

// 验证base64签名
let valid2 = Process(
  'crypto.rsa2verify',
  publicKey,
  'SHA256',
  'message to sign',
  signature,
  'base64'
);

// 使用证书验证
let valid3 = Process(
  'crypto.rsa2verify',
  certificate,
  'SHA256',
  'message',
  signature
);
```

### 参数说明

- `Args[0]`: RSA公钥或证书 (字符串)
  - 支持PEM格式 (会自动添加header/footer)
  - 支持证书格式: `-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----`
  - 支持公钥格式: `-----BEGIN RSA PUBLIC KEY-----\n...\n-----END RSA PUBLIC KEY-----`
- `Args[1]`: 哈希算法名称 (字符串)
- `Args[2]`: 原始值 (字符串)
- `Args[3]`: 签名值 (字符串)
- `Args[4]`: 签名编码 (可选, 默认为hex, 可指定为 "base64")

### 返回值

布尔值, `true` 表示验证成功, `false` 表示验证失败

---

## 6. AES256 加密 (crypto.aes256encrypt)

使用AES-256-GCM算法加密数据。

### 使用示例

```javascript
// 基本加密 (输出十六进制)
let encryptedHex = Process(
  'crypto.aes256encrypt',
  'GCM',
  '32-byte-key-123456789012',
  'nonce-12byte',
  'plaintext',
  ''
);

// 加密并输出base64
let encryptedBase64 = Process(
  'crypto.aes256encrypt',
  'GCM',
  '32-byte-key-123456789012',
  'nonce-12byte',
  'plaintext',
  'additional-data',
  'base64'
);

// 不带附加数据
let encryptedNoAdd = Process(
  'crypto.aes256encrypt',
  'GCM',
  key,
  nonce,
  'sensitive data',
  '',
  'base64'
);
```

### 参数说明

- `Args[0]`: 加密算法, 当前仅支持 "GCM"
- `Args[1]`: 加密密钥, 必须为32字节长度
- `Args[2]`: Nonce (随机数), 通常为12字节
- `Args[3]`: 需要加密的文本
- `Args[4]`: 附加数据 (可选, 可为空字符串 "")
- `Args[5]`: 输出编码 (可选, 默认为hex, 可指定为 "base64")

### 返回值

加密后的密文 (默认十六进制, 可指定base64)

### 注意事项

- 密钥长度必须为32字节 (AES-256)
- Nonce长度推荐为12字节 (GCM模式)
- GCM模式每次加密都应使用不同的nonce

---

## 7. AES256 解密 (crypto.aes256decrypt)

使用AES-256-GCM算法解密数据。

### 使用示例

```javascript
// 解密十六进制密文
let decryptedHex = Process(
  'crypto.aes256decrypt',
  'GCM',
  '32-byte-key-123456789012',
  'nonce-12byte',
  encryptedHex,
  ''
);

// 解密base64密文
let decryptedBase64 = Process(
  'crypto.aes256decrypt',
  'GCM',
  '32-byte-key-123456789012',
  'nonce-12byte',
  encryptedBase64,
  'additional-data',
  'base64'
);
```

### 参数说明

- `Args[0]`: 解密算法, 当前仅支持 "GCM"
- `Args[1]`: 解密密钥, 必须为32字节长度, 与加密时使用的密钥相同
- `Args[2]`: Nonce, 必须与加密时使用的nonce相同
- `Args[3]`: 需要解密的密文
- `Args[4]`: 附加数据 (可选, 必须与加密时使用的附加数据相同)
- `Args[5]`: 密文编码 (可选, 默认为hex, 可指定为 "base64")

### 返回值

解密后的明文字符串

---

## 8. 企业微信消息解密 (crypto.wework.decrypt)

解密企业微信回调的加密消息。

### 使用示例

```javascript
// 解密并解析XML
let result = Process('crypto.wework.decrypt', encodingAESKey, msgEncrypt, true);

// 解密但不解析XML
let resultRaw = Process(
  'crypto.wework.decrypt',
  encodingAESKey,
  msgEncrypt,
  false
);

// 返回结果包含:
// - message: 原始消息字符串
// - data: 解析后的XML数据 (仅当第三个参数为true时)
// - receiveid: 接收人ID
```

### 参数说明

- `Args[0]`: 企业微信的encodingAESKey (base64格式)
- `Args[1]`: 加密的消息密文 (base64格式)
- `Args[2]`: 是否解析XML (布尔值), true表示解析, false表示不解析

### 返回值

Map类型数据, 包含:

- `message`: 原始消息内容 (字符串)
- `data`: XML解析后的数据 (map, 仅当第三个参数为true时返回)
- `receiveid`: 接收人ID (字符串)

---

## 9. XML 解析 (crypto.xml.parse)

将XML字符串解析为Map格式,支持自定义属性和文本的前缀。

### 使用示例

```javascript
// 解析简单XML
let xml = `<root><name>John</name><age>30</age></root>`;
let result = Process('crypto.xml.parse', xml);
// 返回: { "root": { "name": "John", "age": "30" } }

// 解析带属性的XML
let xmlWithAttrs = `<user id="1" name="test"><email>test@example.com</email></user>`;
let resultWithAttrs = Process('crypto.xml.parse', xmlWithAttrs);
// 返回: { "user": { "@id": "1", "@name": "test", "email": "test@example.com" } }

// 使用自定义前缀
let xmlCustom = `<item attr="value">text</item>`;
let resultCustom = Process('crypto.xml.parse', xmlCustom, 'attr_', 'text_');
// 返回: { "item": { "attr_attr": "value", "text_": "text" } }

// 解析嵌套XML
let nestedXml = `<root><parent><child>value</child></parent></root>`;
let nestedResult = Process('crypto.xml.parse', nestedXml);
// 返回: { "root": { "parent": { "child": "value" } } }

// 解析带命名空间的XML
let nsXml = `<root xmlns:ns="http://example.com"><ns:element>value</ns:element></root>`;
let nsResult = Process('crypto.xml.parse', nsXml);
// 返回: { "root": { "example.com:element": "value" } }
```

### 参数说明

- `Args[0]`: XML字符串 (必需)
- `Args[1]`: 属性前缀 (可选, 默认为 "@")
- `Args[2]`: 文本内容前缀 (可选, 默认为 "#text")

### 返回值

Map类型,表示解析后的XML结构:

- 元素名称作为Map的key
- 子元素嵌套在对应的value中
- 属性以指定前缀开头 (默认 "@")
- 当元素既有属性又有文本内容时,文本内容使用指定前缀标识 (默认 "#text")

### 特性

- **属性处理**: XML属性自动提取,使用指定前缀标识
- **命名空间支持**: 自动处理命名空间,格式为 `namespace:element`
- **嵌套结构**: 完整支持XML的嵌套层级结构
- **灵活前缀**: 可自定义属性和文本的前缀,适应不同需求

---

## 完整使用示例

```javascript
// 1. Hash计算
let md5Hash = Process('crypto.Hash', 'MD5', 'hello');
console.log(md5Hash);

// 2. HMAC签名
let hmacSig = Process('crypto.Hmac', 'SHA256', 'data', 'secret', 'base64');
console.log(hmacSig);

// 3. HMAC高级用法
let hmacAdv = Process(
  'crypto.hmacwith',
  {
    key: 'hex',
    value: 'base64',
    output: 'base64',
    algo: 'SHA512'
  },
  'data',
  'key'
);

// 4. RSA签名和验证
let signature = Process(
  'crypto.rsa2sign',
  privateKey,
  'SHA256',
  'message',
  'base64'
);
let verified = Process(
  'crypto.rsa2verify',
  publicKey,
  'SHA256',
  'message',
  signature,
  'base64'
);

// 5. AES加密解密
let key = '32-byte-key-for-encryption-123'; // 必须为32字节
let nonce = '12-byte-nonce'; // 12字节
let encrypted = Process(
  'crypto.aes256encrypt',
  'GCM',
  key,
  nonce,
  'secret',
  '',
  'base64'
);
let decrypted = Process(
  'crypto.aes256decrypt',
  'GCM',
  key,
  nonce,
  encrypted,
  '',
  'base64'
);

// 6. 企业微信解密
let weworkMsg = Process(
  'crypto.wework.decrypt',
  encodingKey,
  encryptedMsg,
  true
);
```

---

## 支持的哈希算法列表

- `MD4` (映射到MD5)
- `MD5`
- `SHA1`
- `SHA224`
- `SHA256`
- `SHA384`
- `SHA512`
- `MD5SHA1`
- `RIPEMD160`
- `SHA3_224`
- `SHA3_256`
- `SHA3_384`
- `SHA3_512`
- `SHA512_224`
- `SHA512_256`
- `BLAKE2s_256`
- `BLAKE2b_256`
- `BLAKE2b_384`
- `BLAKE2b_512`

---

## 注意事项

1. **密钥管理**: RSA和AES的密钥应该妥善保管, 不要硬编码在代码中
2. **Nonce复用**: AES-GCM的nonce每次加密必须不同, 否则会降低安全性
3. **编码一致性**: 加密/签名和解密/验证时使用的编码必须一致
4. **密钥长度**: AES-256要求密钥长度为32字节
5. **错误处理**: 当算法不支持或参数错误时会抛出异常
