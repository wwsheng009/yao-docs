# Pipe 变量（$input / $in / $out 等）作用域与使用指南

> ⚠️ **重要**：以下示例默认使用 **JSON 格式**（`.pip.yao` / `.pipe.yao`）。
>
> 📖 需要 JSON 注意事项请先看：[JSON-格式说明](./JSON-格式说明.md)

本文聚焦 Pipe 运行时可用变量：`$input`、`$in`、`$out` 以及其它常见变量（`$output/$global/$sid/$node.*`、节点名引用等），并说明它们在 **Pipe 流程的不同阶段** 的差异与注意事项。

## 1. 最常用的区别：`$input` vs `$in`

- **`$input`**：**Pipe 级**入参（整条 Pipe 的输入）。
  - 含义：Pipe 启动时传入的参数，在执行过程中保持为“本次 Pipe 的输入快照”。
  - 典型用途：
    - 在 `Pipe.input`（Pipe 级输入映射）里引用外部参数
    - 在“没有节点上下文”的表达式里引用外部参数（例如 switch 的控制分支子 pipe，无 nodes）

- **`$in`**：**Node 级**入参（当前节点的输入）。
  - 含义：每个节点执行前都会计算当前节点的输入（可被 `node.input` 映射改写），节点内部/节点配置通常用 `$in`。
  - 典型用途：
    - `node.process.args`、`node.prompts.content` 等节点内部字段
    - `node.goto` / `node.output` 中引用节点输入

一句话：

- **想拿“整条 Pipe 的入参”用 `$input`**。
- **想拿“当前节点的入参”用 `$in`**。

## 2. Pipe 流程中其它内置变量一览

### 2.1 Pipe 级变量（基本全程可用）

| 变量      | 类型   | 含义                                 | 常见用法                |
| --------- | ------ | ------------------------------------ | ----------------------- |
| `$input`  | array  | Pipe 入参                            | `{{ $input[0] }}`       |
| `$output` | any    | Pipe 最终输出（Pipe 结束时才有意义） | `{{ $output }}`         |
| `$global` | map    | 全局数据（通过 `WithGlobal` 注入）   | `{{ $global.user_id }}` |
| `$sid`    | string | 会话 ID（通过 `WithSid` 注入）       | `{{ $sid }}`            |

### 2.2 Node 级变量（只有“当前节点上下文”才有意义）

| 变量   | 类型  | 含义                                                      | 常见用法       |
| ------ | ----- | --------------------------------------------------------- | -------------- |
| `$in`  | array | 当前节点输入（执行前）                                    | `{{ $in[0] }}` |
| `$out` | any   | 当前节点输出（执行后，或在 `node.output` 中表示原始输出） | `{{ $out }}`   |

> 注意：`$out` 的“值”取决于你站在什么阶段。
>
> - 在节点执行**刚结束**时：`$out` 是该节点的原始输出。
> - 在 `node.output` 表达式里：`$out` 仍指该节点的原始输出，你可以用它加工得到“节点最终输出”。

### 2.3 跨节点访问（推荐方式）

| 变量               | 含义                       | 示例                        |
| ------------------ | -------------------------- | --------------------------- |
| `$node.<name>.in`  | 指定节点的输入历史         | `{{ $node.user.in[0] }}`    |
| `$node.<name>.out` | 指定节点的输出历史（稳定） | `{{ $node.translate.out }}` |

推荐理由：

- **稳定**：即使嵌套 pipe/子 pipe 里出现重名节点，也可以避免“同名覆盖顺序不稳定”的问题。

### 2.4 节点名引用（便捷但需注意重名）

在表达式里直接写节点名（例如 `{{ user }}`、`{{ translate.Chinese }}`）通常表示“某个节点的输出”。

- 优点：写起来短。
- 风险：**节点重名**时可读性变差，且在嵌套 pipe 场景下更容易产生歧义。
- 建议：
  - 简单 Pipe 可以用节点名。
  - **复杂/嵌套** Pipe 优先用 `{{ $node.<name>.out }}`。

## 3. 各配置位置应该用哪个变量？（对照表）

### 3.1 Pipe 根级配置

- **`pipe.input`（Pipe 级入参映射）**
  - 推荐使用：`$input`（表示启动入参）
  - 示例：

```json
{
  "input": ["{{ $input[0].cmd }}", "{{ $input[0].args }}"]
}
```

- **`pipe.output`（Pipe 最终输出映射）**
  - 推荐使用：`$output`、节点名、`$node.*.out`

### 3.2 Node 配置

- **`node.input`（节点输入映射）**
  - 推荐使用：`$in`（表示该节点收到的输入）
  - 示例：`"input": ["{{ $in[0] }}"]`

- **`node.process.args` / `node.prompts.content`**
  - 推荐使用：`$in`、节点名、`$node.*.out`

- **`node.output`（节点输出映射）**
  - 推荐使用：`$out`（节点原始输出）、`$in`、`$node.*`

- **`node.goto`（节点跳转）**
  - 可使用：`$in`、`$out`、节点名、`$node.*`

## 4. switch（case 子 pipe）里的变量：最容易踩坑的地方

switch 的 `case` value 是一个“子 Pipe”。它有两类用法：

### 4.1 case 子 pipe **有 nodes**（正常子流程）

- 子 pipe 里每个节点都有自己的 `$in/$out`。
- 子 pipe 根级也有 `$input/$output`。

### 4.2 case 子 pipe **无 nodes**（控制分支：只有 goto/input/output）

这是常见配置：只想在命中某分支后“改输入 + 跳转”，不想写子节点。

**重点**：无 nodes 时子 pipe 不会进入节点执行阶段，因此：

- 子 pipe 的表达式 **应使用 `$input` / `$output`**。
- 子 pipe 里 **不要用 `$in/$out`**（因为没有“当前节点上下文”）。

示例（推荐写法）：

```json
{
  "name": "switch",
  "case": {
    "default": {
      "input": "{{ $input[0] }}",
      "goto": "help",
      "output": { "cmd": "{{ $input[0].cmd }}" }
    }
  }
}
```

## 5. 使用注意事项（经验总结）

- **注意 1：明确作用域**
  - Pipe 级用 `$input/$output`
  - Node 级用 `$in/$out`

- **注意 2：跨节点引用优先用 `$node.<name>.out`**
  - 尤其是嵌套 pipe、或者你未来可能复制粘贴节点导致重名时。

- **注意 3：`$output` 在 Pipe 结束前可能为空**
  - 因为它代表 Pipe 最终输出（`pipe.output` 解析后的值）。

- **注意 4：未定义变量通常不会直接报错**
  - 表达式引擎允许未定义变量（会得到 `null` / `nil`），这有利于容错，但也更容易“静默出错”。
  - 建议在关键节点加上校验（例如 `utils.json.Validate`）或在流程中打印调试信息。

- **注意 5：在参数列表里传数组时，区分“要不要展开”**
  - `node.input` / `pipe.input` 中的表达式返回数组，通常会被当作“多参数”使用（更符合直觉）。
  - 但 `process.args` 通常希望“数组作为一个参数”传入（不要无脑展开）。

## 6. 相关文档

- [表达式引擎](./expression.md)
- [执行流程](./execution.md)
- [节点类型](./nodes.md)
