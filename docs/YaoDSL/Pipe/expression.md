# è¡¨è¾¾å¼å¼•æ“

> âš ï¸ **é‡è¦**: é…ç½®ç¤ºä¾‹ä½¿ç”¨ **JSON æ ¼å¼**ï¼Œä¸æ˜¯ YAMLï¼
>
> ğŸ“– æŸ¥çœ‹ [JSON æ ¼å¼è¯´æ˜](./JSON-æ ¼å¼è¯´æ˜.md) äº†è§£è¯¦ç»†çš„è½¬æ¢æŒ‡å—

Pipe ä½¿ç”¨å¼ºå¤§çš„è¡¨è¾¾å¼å¼•æ“æ¥å¤„ç†æ•°æ®ç»‘å®šã€æ¡ä»¶åˆ¤æ–­å’ŒåŠ¨æ€è®¡ç®—ã€‚è¡¨è¾¾å¼å¼•æ“åŸºäº Expr åº“å®ç°ï¼Œæ”¯æŒä¸°å¯Œçš„è¯­æ³•å’ŒåŠŸèƒ½ã€‚

## åŸºæœ¬è¯­æ³•

### è¡¨è¾¾å¼æ ¼å¼

è¡¨è¾¾å¼ä½¿ç”¨åŒèŠ±æ‹¬å· `{{ }}` åŒ…è£¹ï¼š

```json
// ç®€å•å˜é‡å¼•ç”¨
{{ $global.user_id }}

// è¡¨è¾¾å¼è®¡ç®—
{{ $in[0] + $in[1] }}

// æ¡ä»¶è¡¨è¾¾å¼
{{ $in[0] > 10 ? 'large' : 'small' }}

// å‡½æ•°è°ƒç”¨
{{ now() }}

// å¯¹è±¡è®¿é—®
{{ $user.profile.name }}
```

### è¡¨è¾¾å¼ä¸­çš„ HTML ç¼–ç 

åœ¨ JSON ä¸­éœ€è¦æ³¨æ„ç‰¹æ®Šå­—ç¬¦çš„è½¬ä¹‰ï¼š

```json
// âŒ é”™è¯¯ï¼šåŒå¼•å·åœ¨è¡¨è¾¾å¼ä¸­
{{ $in[0].say "hello" }}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ HTML ç¼–ç 
{{ $in[0].say &#34;hello&#34; }}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å•å¼•å·
{{ $in[0].say 'hello' }}
```

## å†…ç½®å˜é‡

### å…¨å±€å˜é‡

| å˜é‡      | ç±»å‹   | è¯´æ˜          | ç¤ºä¾‹                    |
| --------- | ------ | ------------- | ----------------------- |
| `$global` | map    | å…¨å±€æ•°æ®      | `{{ $global.user_id }}` |
| `$input`  | array  | Pipe è¾“å…¥æ•°æ® | `{{ $input[0] }}`       |
| `$output` | any    | Pipe è¾“å‡ºæ•°æ® | `{{ $output.result }}`  |
| `$sid`    | string | ä¼šè¯ID        | `{{ $sid }}`            |

### èŠ‚ç‚¹å˜é‡

| å˜é‡   | ç±»å‹  | è¯´æ˜         | ç¤ºä¾‹           |
| ------ | ----- | ------------ | -------------- |
| `$in`  | array | å½“å‰èŠ‚ç‚¹è¾“å…¥ | `{{ $in[0] }}` |
| `$out` | any   | å½“å‰èŠ‚ç‚¹è¾“å‡º | `{{ $out }}`   |

### è·¨èŠ‚ç‚¹è®¿é—®

| å˜é‡               | è¯´æ˜         | ç¤ºä¾‹                             |
| ------------------ | ------------ | -------------------------------- |
| `$node.<name>.in`  | æŒ‡å®šèŠ‚ç‚¹è¾“å…¥ | `{{ $node.validate.in[0] }}`     |
| `$node.<name>.out` | æŒ‡å®šèŠ‚ç‚¹è¾“å‡º | `{{ $node.process.out.result }}` |

## æ•°æ®ç±»å‹

### åŸºæœ¬ç±»å‹

```json
// å­—ç¬¦ä¸²
"{{ $global.name }}"

// æ•°å­—
"{{ $global.age }}"

// å¸ƒå°”å€¼
"{{ $global.is_active }}"

// ç©ºå€¼
"{{ $global.data == null }}"
```

### æ•°ç»„æ“ä½œ

```json
// æ•°ç»„è®¿é—®
"{{ $in[0] }}"
"{{ $items[1].name }}"

// æ•°ç»„é•¿åº¦
"{{ len($items) }}"

// æ•°ç»„éå†ï¼ˆåœ¨æ”¯æŒçš„ç¯å¢ƒä¸­ï¼‰
"{{ $items[0].name }}"
"{{ $items[1].price }}"
```

### å¯¹è±¡æ“ä½œ

```json
// å¯¹è±¡å±æ€§
"{{ $user.name }}"
"{{ $user.profile.email }}"

// åµŒå¥—è®¿é—®
"{{ $data.items[0].specs.color }}"

// å®‰å…¨è®¿é—®ï¼ˆå¦‚æœå±æ€§å¯èƒ½ä¸å­˜åœ¨ï¼‰
"{{ $user?.name }}"
```

## è¿ç®—ç¬¦

### ç®—æœ¯è¿ç®—

```json
// åŠ æ³•
"{{ a + b }}"
// å‡æ³•
"{{ a - b }}"
// ä¹˜æ³•
"{{ a * b }}"
// é™¤æ³•
"{{ a / b }}"
// å–æ¨¡
"{{ a % b }}"
// å¹‚è¿ç®—
"{{ a ** b }}"
```

### æ¯”è¾ƒè¿ç®—

```json
// ç­‰äº
"{{ a == b }}"
// ä¸ç­‰äº
"{{ a != b }}"
// å°äº
"{{ a < b }}"
// å°äºç­‰äº
"{{ a <= b }}"
// å¤§äº
"{{ a > b }}"
// å¤§äºç­‰äº
"{{ a >= b }}"
```

### é€»è¾‘è¿ç®—

```json
// é€»è¾‘ä¸
"{{ a and b }}"
// é€»è¾‘æˆ–
"{{ a or b }}"
// é€»è¾‘é
"{{ not a }}"
// ä¸‰å…ƒè¿ç®—ç¬¦
"{{ a ? b : c }}"
```

### å­—ç¬¦ä¸²è¿ç®—

```json
// å­—ç¬¦ä¸²è¿æ¥
"{{ str1 + str2 }}"
// å­—ç¬¦ä¸²ç›¸ç­‰
"{{ str1 == str2 }}"
// å­—ç¬¦ä¸²ä¸ç­‰
"{{ str1 != str2 }}"
```

## å†…ç½®å‡½æ•°

### æ—¶é—´å‡½æ•°

```json
// å½“å‰æ—¶é—´
"{{ now() }}"
// Unix æ—¶é—´æˆ³
"{{ now().Unix() }}"
// æ ¼å¼åŒ–æ—¶é—´
"{{ now().Format('2006-01-02') }}"
```

### å­—ç¬¦ä¸²å‡½æ•°

```json
// è½¬å¤§å†™ -> HELLO
"{{ upper('hello') }}"
// è½¬å°å†™ -> world
"{{ lower('WORLD') }}"
// å­—ç¬¦ä¸²é•¿åº¦ -> 5
"{{ len('hello') }}"
// åˆ†å‰²å­—ç¬¦ä¸² -> [a, b, c]
"{{ split('a,b,c', ',') }}"
// è¿æ¥æ•°ç»„ -> a,b
"{{ join(['a', 'b'], ',') }}"
// å»é™¤é¦–å°¾ç©ºæ ¼ -> hello
"{{ trim('  hello  ') }}"
```

### æ•°ç»„å‡½æ•°

```json
// æ•°ç»„é•¿åº¦ -> 3
"{{ len([1, 2, 3]) }}"
// ç¬¬ä¸€ä¸ªå…ƒç´  -> 1
"{{ first([1, 2, 3]) }}"
// æœ€åä¸€ä¸ªå…ƒç´  -> 3
"{{ last([1, 2, 3]) }}"
// æ±‚å’Œ -> 6
"{{ sum([1, 2, 3]) }}"
```

### æ•°å­¦å‡½æ•°

```json
// ç»å¯¹å€¼ -> 5
"{{ abs(-5) }}"
// æœ€å¤§å€¼ -> 5
"{{ max(1, 5, 3) }}"
// æœ€å°å€¼ -> 1
"{{ min(1, 5, 3) }}"
// å››èˆäº”å…¥ -> 3.14
"{{ round(3.14159, 2) }}"
```

### ç±»å‹è½¬æ¢

```json
// è½¬å­—ç¬¦ä¸² -> "123"
"{{ string(123) }}"
// è½¬æ•´æ•° -> 456
"{{ int("456") }}"
// è½¬æµ®ç‚¹æ•° -> 3.14
"{{ float("3.14") }}"
// è½¬å¸ƒå°”å€¼ -> true
"{{ bool("true") }}"
```

## é«˜çº§ç‰¹æ€§

### æ¡ä»¶è¡¨è¾¾å¼

```json
// ä¸‰å…ƒè¿ç®—ç¬¦
"{{ $in[0] > 10 ? 'large' : 'small' }}"

// åµŒå¥—æ¡ä»¶
"{{ $user.type == 'vip' ? ($user.level > 5 ? 'vip5+' : 'vip') : 'normal' }}"

// å¤šæ¡ä»¶
"{{ $age >= 18 and $has_id ? 'adult' : 'minor' }}"
```

### æ•°ç»„æ“ä½œ

```json
// æ•°ç»„è¿‡æ»¤
{{ [1, 2, 3, 4, 5].filter(#value > 3) }}    // [4, 5]

// æ•°ç»„æ˜ å°„
{{ [1, 2, 3].map(#value * 2) }}              // [2, 4, 6]

// æ•°ç»„åŒ…å«
{{ [1, 2, 3].includes(2) }}                  // true
```

### å¯¹è±¡æ“ä½œ

```json
// å¯¹è±¡åˆ›å»º
{{ {"name": "John", "age": 30} }}

// å¯¹è±¡å±æ€§è®¿é—®
{{ user.profile?.email }}

// å¯¹è±¡é”®å€¼å¯¹
{{ Object.keys(user) }}
```

### æ­£åˆ™è¡¨è¾¾å¼

```json
// æ­£åˆ™åŒ¹é…
{{ "hello123".matches("^[a-z]+") }}          // true

// æ­£åˆ™æ›¿æ¢
{{ "hello world".replace("world", "everyone") }} // hello everyone
```

## ä½¿ç”¨åœºæ™¯

### è¾“å…¥æ•°æ®å¤„ç†

```json
// èŠ‚ç‚¹è¾“å…¥é…ç½®
{
  "input": [
    "{{ $global.api_key }}", // ä½¿ç”¨å…¨å±€é…ç½®
    "{{ $input[0] }}", // ä½¿ç”¨ç®¡é“è¾“å…¥
    "{{ now().Format('2006-01-02') }}", // ä½¿ç”¨å½“å‰æ—¶é—´
    "{{ $user.id ?? 'anonymous' }}" // ä½¿ç”¨é»˜è®¤å€¼
  ]
}
```

### è¾“å‡ºæ•°æ®æ ¼å¼åŒ–

```json
// èŠ‚ç‚¹è¾“å‡ºé…ç½®
{
  "output": {
    "result": "{{ $out.data }}", // ç®€å•æ˜ å°„
    "success": "{{ $out.error == null }}", // æ¡ä»¶åˆ¤æ–­
    "timestamp": "{{ now().Unix() }}", // æ—¶é—´æˆ³
    "user_info": {
      "id": "{{ $global.user.id }}",
      "name": "{{ $global.user.name }}",
      "type": "{{ $global.user.type ?? 'guest' }}"
    }
  }
}
```

### æ¡ä»¶åˆ†æ”¯

```json
// Switch èŠ‚ç‚¹é…ç½®
{
  "switch": {
    "{{ $in[0].type == 'image' }}": {
      // å›¾åƒå¤„ç†åˆ†æ”¯
    },
    "{{ $in[0].type == 'text' and len($in[0].content) > 100 }}": {
      // é•¿æ–‡æœ¬å¤„ç†åˆ†æ”¯
    },
    "{{ contains($in[0].tags, 'urgent') or $global.priority == 'high' }}": {
      // ç´§æ€¥å¤„ç†åˆ†æ”¯
    }
  }
}
```

### AI æç¤ºè¯åŠ¨æ€ç”Ÿæˆ

```json
// AI èŠ‚ç‚¹æç¤ºè¯
{
  "prompts": [
    {
      "role": "system",
      "content": "ä½ æ˜¯{{ $global.assistant_name }}ï¼Œä¸“é—¨å¤„ç†{{ $global.domain}}ç›¸å…³é—®é¢˜"
    },
    {
      "role": "user",
      "content": "ç”¨æˆ·ç±»å‹ï¼š{{ $global.user.type ?? 'æ™®é€šç”¨æˆ·' }}\né—®é¢˜å†…å®¹ï¼š{{ $in[0] }}\nä¸Šä¸‹æ–‡ï¼š{{ $global.context ?? 'æ— ' }}\n\nè¯·æ ¹æ®ç”¨æˆ·ç±»å‹æä¾›ç›¸åº”çš„å›ç­”ã€‚"
    }
  ]
}
```

### è·³è½¬æ§åˆ¶

```json
// Goto é…ç½®
{
  "goto": "{{ $out.success ? 'next-step' : 'error-handler' }}"
}

// å¤æ‚è·³è½¬é€»è¾‘
{
  "goto": "{{ $out.status == 'completed' ? 'complete' : $out.status == 'error' ? 'retry' : $out.requires_approval ? 'approve' : 'default-handler' }}"
}
```

## æ•°æ®è½¬æ¢ç¤ºä¾‹

### å¤æ‚æ•°æ®ç»“æ„å¤„ç†

```json
// ä» API å“åº”ä¸­æå–æ•°æ®
{
  "output": {
    "users": "{{ $out.data.users.map(#user => { 'id': #user.id, 'name': #user.name, 'email': #user.email }) }}",
    "total": "{{ $out.data.pagination.total }}",
    "has_more": "{{ $out.data.pagination.page < $out.data.pagination.total_pages }}"
  }
}
```

### æ•°æ®éªŒè¯

```json
// è¾“å…¥éªŒè¯
{
  "output": {
    "is_valid": "{{ $in[0] != null and len($in[0].name) > 0 and $in[0].email.matches('^[^@]+@[^@]+\\.[^@]+$') and $in[0].age >= 18 and $in[0].age <= 120 }}",
    "errors": "{{ $in[0] == null ? ['è¾“å…¥ä¸èƒ½ä¸ºç©º'] : len($in[0].name) == 0 ? ['å§“åä¸èƒ½ä¸ºç©º'] : !$in[0].email.matches('^[^@]+@[^@]+\\.[^@]+$') ? ['é‚®ç®±æ ¼å¼ä¸æ­£ç¡®'] : $in[0].age < 18 ? ['å¹´é¾„å¿…é¡»å¤§äº18å²'] : $in[0].age > 120 ? ['å¹´é¾„ä¸èƒ½è¶…è¿‡120å²'] : [] }}"
  }
}
```

### æ ¼å¼åŒ–è¾“å‡º

```json
// å¤šç§æ ¼å¼è¾“å‡º
{
  "output": {
    "json_format": "{{ $json($out) }}", // JSON å­—ç¬¦ä¸²
    "csv_format": "{{ join($out.map(#item => `${#item.id},${#item.name}`), '\\n') }}",
    "summary": "å…±{{ len($out) }}æ¡è®°å½•ï¼Œæ€»è®¡{{ sum($out.map(#item => #item.amount)) }}å…ƒ",
    "detailed_report": "{{ `æ•°æ®æŠ¥å‘Šï¼š\\nå¤„ç†æ—¶é—´ï¼š${now().Format('2006-01-02 15:04:05')}\\nè®°å½•æ•°é‡ï¼š${len($out)}\\næˆåŠŸç‡ï¼š${len($out.filter(#item => #item.status == 'success')) / len($out) * 100}%\\nè¯¦ç»†æ•°æ®ï¼š${$json($out)}` }}"
  }
}
```

## æœ€ä½³å®è·µ

### 1. è¡¨è¾¾å¼å¯è¯»æ€§

```json
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å
{{ $user.is_vip ? 'vip_price' : 'normal_price' }}

// âœ… å¥½çš„åšæ³•ï¼šå¤šè¡Œå¤æ‚è¡¨è¾¾å¼
{
  "goto": "{{ $out.status == 'success' ? 'next-step' : $out.status == 'pending' ? 'wait-approval' : 'error-handler' }}"
}

// âŒ é¿å…çš„åšæ³•ï¼šè¿‡äºå¤æ‚çš„å•è¡Œè¡¨è¾¾å¼
{{ $out.status=='success'?'next-step':$out.status=='pending'?'wait-approval':'error-handler' }}
```

### 2. é”™è¯¯å¤„ç†

```json
// âœ… ä½¿ç”¨ç©ºå€¼å®‰å…¨æ“ä½œç¬¦
{{ $user?.profile?.email ?? 'no-email@example.com' }}

// âœ… æä¾›é»˜è®¤å€¼
{{ $global.timeout ?? 30 }}

// âœ… æ¡ä»¶æ£€æŸ¥
{{ $in[0] != null ? $in[0].name : 'unknown' }}
```

### 3. æ€§èƒ½è€ƒè™‘

```json
// âœ… é¿å…é‡å¤è®¡ç®—ï¼ˆåœ¨å¤æ‚è¡¨è¾¾å¼ä¸­ï¼‰
{{ let total = sum($items.map(#item => #item.price * #item.quantity)); total > 1000 ? total * 0.9 : total }}

// âœ… ä½¿ç”¨é€‚å½“çš„å‡½æ•°
{{ contains($tags, 'urgent') }}  // æ¯” $tags.includes('urgent') æ›´æ˜ç¡®
```

### 4. å®‰å…¨æ€§

```json
// âœ… è¾“å…¥éªŒè¯
{{ $input.matches('^[a-zA-Z0-9]+$') ? $input : 'invalid' }}

// âœ… é•¿åº¦é™åˆ¶
{{ len($in[0]) > 1000 ? $in[0][:1000] : $in[0] }}
```

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•å¤„ç† JSON æ•°æ®ï¼Ÿ

```json
// å°†å¯¹è±¡è½¬ä¸º JSON å­—ç¬¦ä¸²
{{ $json($out) }}

// å°† JSON å­—ç¬¦ä¸²è§£æä¸ºå¯¹è±¡
{{ $parseJson($input) }}
```

### Q: å¦‚ä½•å¤„ç†æ•°ç»„ä¸­çš„ç©ºå€¼ï¼Ÿ

```json
// è¿‡æ»¤ç©ºå€¼
{{ $items.filter(#item => #item != null) }}

// ä½¿ç”¨é»˜è®¤å€¼
{{ $items[0] ?? 'default_value' }}
```

### Q: å¦‚ä½•æ ¼å¼åŒ–æ•°å­—ï¼Ÿ

```json
// ä¿ç•™å°æ•°ä½
{{ round($price, 2) }}

// æ·»åŠ åƒä½åˆ†éš”ç¬¦
{{ formatNumber($amount, 'en-US') }}
```

### Q: å¦‚ä½•å¤„ç†æ—¥æœŸæ—¶é—´ï¼Ÿ

```json
// æ ¼å¼åŒ–æ—¥æœŸ
{{ now().Format('2006-01-02 15:04:05') }}

// æ—¥æœŸè®¡ç®—
{{ now().AddDate(0, 0, 7).Format('2006-01-02') }}  // 7å¤©åçš„æ—¥æœŸ
```
