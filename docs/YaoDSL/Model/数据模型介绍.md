# 数据模型

## 目录

- [1. 概述](#1-概述)
- [2. 命名规范](#2-命名规范)
- [3. 文档结构](#3-文档结构)
- [4. 查询参数](#4-查询参数-queryparam)
- [5. 处理器](#5-处理器process)
- [6. 完整示例](#6-完整示例)

## 1. 概述

Yao 数据模型是应用的核心组件，它使系统能够：

- **自动数据迁移**：根据模型定义创建和更新数据库表结构
- **元数据原子操作**：提供标准化的数据操作方法
- **数据校验**：基于模型定义进行输入数据的合法性验证
- **自动管理后台**：生成数据管理界面

数据模型将操作方法映射为处理器(`process`)，可在数据流（`Flow`）和接口(`API`)中直接调用。对于使用`golang`开发的业务插件，可通过`Gou`包访问模型方法。

## 2. 命名规范

数据模型使用**小写英文字母**命名的JSON文件：`<name>.mod.json`

| 文件位置        | 文件名        | 模型名称             | 处理器调用方式                        |
| --------------- | ------------- | -------------------- | ------------------------------------- |
| /               | name.mod.json | `name`               | `models.name.<process>`               |
| /group/         | name.mod.json | `group.name`         | `models.group.name.<process>`         |
| /group1/group2/ | name.mod.json | `group1.group2.name` | `models.group1.group2.name.<process>` |

## 3. 文档结构

数据模型定义文件包含以下主要部分：

```json
{
  "name": "用户", // 模型中文名称
  "table": {}, // 数据表定义
  "columns": [], // 字段定义
  "indexes": [], // 索引定义
  "relations": {}, // 关系映射
  "values": [], // 默认数据
  "option": {} // 配置选项
}
```

详细的字段类型、验证规则和关联关系说明请参考：[定义Yao模型](定义Yao模型.md)

## 4. 查询参数 `QueryParam`

查询参数用于在关系定义和API调用中描述数据过滤、排序和关联查询条件。

```json
{
  "select": ["id", "name", "mobile"], // 查询字段
  "wheres": [
    // 查询条件
    { "column": "status", "value": "enabled" }
  ],
  "orders": [
    // 排序条件
    { "column": "id", "option": "desc" }
  ],
  "withs": {
    // 关联查询
    "profile": { "select": ["avatar"] }
  },
  "limit": 10, // 返回记录数
  "page": 1, // 页码
  "pagesize": 20 // 每页记录数
}
```

### 查询条件格式

```json
{
  "wheres": [
    {
      "column": "status", // 字段名
      "value": "enabled", // 匹配值
      "op": "eq", // 操作符(可选,默认eq)
      "method": "where" // 方法(可选,默认where)
    },
    {
      "rel": "profile", // 关联模型名
      "column": "is_verified", // 关联模型字段
      "value": true
    },
    {
      "wheres": [
        // 分组条件(OR)
        { "column": "name", "value": "%张%", "op": "like" },
        { "method": "orwhere", "column": "name", "value": "%李%", "op": "like" }
      ]
    }
  ]
}
```

### 常用操作符

| 操作符  | 说明       | SQL等价             |
| ------- | ---------- | ------------------- |
| eq      | 等于(默认) | `field = value`     |
| like    | 模糊匹配   | `field LIKE value`  |
| gt      | 大于       | `field > value`     |
| ge      | 大于等于   | `field >= value`    |
| lt      | 小于       | `field < value`     |
| le      | 小于等于   | `field <= value`    |
| in      | 包含       | `field IN (values)` |
| null    | 为空       | `field IS NULL`     |
| notnull | 不为空     | `field IS NOT NULL` |

## 5. 处理器(`process`)

数据模型自动生成以下处理器，可在API和Flow中使用：

| 处理器       | 调用方式                     | 功能                              |
| ------------ | ---------------------------- | --------------------------------- |
| find         | `models.模型名.find`         | 查询单条记录                      |
| get          | `models.模型名.get`          | 按条件查询(不分页)                |
| paginate     | `models.模型名.paginate`     | 按条件查询(分页)                  |
| create       | `models.模型名.create`       | 创建单条记录                      |
| update       | `models.模型名.update`       | 更新单条记录                      |
| save         | `models.模型名.save`         | 保存记录(存在则更新,不存在则创建) |
| delete       | `models.模型名.delete`       | 删除单条记录(软删除)              |
| destroy      | `models.模型名.destroy`      | 删除单条记录(物理删除)            |
| insert       | `models.模型名.insert`       | 批量插入记录                      |
| updatewhere  | `models.模型名.updatewhere`  | 按条件更新记录                    |
| deletewhere  | `models.模型名.deletewhere`  | 按条件删除记录(软删除)            |
| destroywhere | `models.模型名.destroywhere` | 按条件删除记录(物理删除)          |
| eachsave     | `models.模型名.eachsave`     | 批量保存记录                      |

## 6. 完整示例

以下是一个完整的用户模型定义示例：

```json
{
  "name": "用户",
  "table": {
    "name": "user",
    "comment": "用户信息表",
    "engine": "InnoDB"
  },
  "columns": [
    { "label": "ID", "name": "id", "type": "ID" },
    {
      "label": "用户名",
      "name": "username",
      "type": "string",
      "length": 50,
      "unique": true,
      "comment": "登录用户名",
      "validations": [
        {
          "method": "typeof",
          "args": ["string"],
          "message": "{{label}}必须是字符串"
        },
        {
          "method": "minLength",
          "args": [3],
          "message": "{{label}}长度至少为3个字符"
        }
      ]
    },
    {
      "label": "密码",
      "name": "password",
      "type": "string",
      "length": 256,
      "comment": "登录密码",
      "crypt": "PASSWORD",
      "validations": [
        {
          "method": "pattern",
          "args": [
            "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{8,}$"
          ],
          "message": "{{label}}必须包含大小写字母、数字和特殊字符，且长度不少于8位"
        }
      ]
    },
    {
      "label": "状态",
      "name": "status",
      "type": "enum",
      "option": ["active", "inactive", "banned"],
      "default": "inactive",
      "comment": "用户状态",
      "index": true
    }
  ],
  "indexes": [
    {
      "name": "username_status_index",
      "comment": "用户名和状态联合索引",
      "columns": ["username", "status"],
      "type": "index"
    }
  ],
  "relations": {
    "profile": {
      "type": "hasOne",
      "model": "user_profile",
      "key": "user_id",
      "foreign": "id"
    },
    "orders": {
      "type": "hasMany",
      "model": "order",
      "key": "user_id",
      "foreign": "id",
      "query": { "limit": 10 }
    }
  },
  "values": [
    {
      "username": "admin",
      "password": "Admin@123",
      "status": "active"
    }
  ],
  "option": {
    "timestamps": true,
    "soft_deletes": true
  }
}
```
