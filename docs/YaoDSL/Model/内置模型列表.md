# Yao 内置模型列表

本文档列出了 Yao 框架中所有内置的数据模型及其说明。

## 目录

- [核心系统模型](#核心系统模型)
- [用户与认证模型](#用户与认证模型)
- [团队与成员模型](#团队与成员模型)
- [AI 助手模型](#ai-助手模型)
- [任务调度模型](#任务调度模型)
- [知识库模型](#知识库模型)

---

## 核心系统模型

### Attachment (附件)

**表名**: `attachment`  
**标签**: `system`  
**说明**: 用于存储文件附件及其元数据和访问控制的附件表

**主要字段**:

- `file_id`: 文件唯一标识
- `uploader`: 上传者类型
- `content_type`: 文件内容类型
- `content`: 从图片、PDF、Word 等文件类型解析的完整文本内容
- `content_preview`: 解析文本内容的预览（前 2000 字符）
- `name`: 文件名
- `url`: 文件 URL
- `type`: 文件类型
- `user_path`: 用户指定的完整文件路径
- `path`: 文件实际存储路径
- `gzip`: 文件是否被 gzip 压缩
- `bytes`: 文件大小（字节）
- `status`: 文件处理状态（uploading/uploaded/indexing/indexed/upload_failed/index_failed）
- `public`: 是否跨所有团队共享的公共附件
- `share`: 附件共享范围（private/team）

---

### Audit Log (审计日志)

**表名**: `audit_log`  
**标签**: `system`  
**说明**: 用于存储系统操作审计记录的审计日志表

**主要字段**:

- `event_id`: 唯一事件标识符（用于关联）
- `operation`: 操作名称（login/delete/modify 等）
- `category`: 审计类别（authentication/authorization/data/system）
- `severity`: 事件严重级别（low/medium/high/critical）
- `user_id`: 用户或服务账号标识
- `user_name`: 用户显示名称
- `session_id`: 会话标识
- `client_ip`: 客户端 IP 地址
- `user_agent`: 客户端用户代理信息
- `target_resource`: 操作的目标资源
- `resource_type`: 资源类型（file/table/config 等）
- `source`: 操作来源（UI/API/CLI/system）
- `application`: 应用程序或服务名称
- `success`: 操作是否成功
- `exit_code`: 系统调用返回码
- `response_time`: 操作响应时间（毫秒）
- `request_id`: HTTP 请求标识符
- `trace_id`: 分布式追踪标识符
- `data_before`: 操作前的数据状态
- `data_after`: 操作后的数据状态
- `details`: 其他操作详细信息和参数
- `error_message`: 操作失败时的错误消息
- `tags`: 用于分类的其他标签

**索引**:

- `idx_user_operation`: 用户和操作组合索引
- `idx_resource_operation`: 资源和操作组合索引
- `idx_time_user`: 时间和用户组合索引

---

### Configuration (配置)

**表名**: `config`  
**标签**: `system`  
**说明**: 用于存储系统设置和参数的配置表

**主要字段**:

- `key`: 配置键（唯一）
- `value`: 配置值（JSON 格式）
- `description`: 配置说明
- `category`: 配置类别
- `type`: 配置值类型
- `readonly`: 配置是否只读

---

### DSL (DSL 配置)

**表名**: `dsl`  
**标签**: `system`  
**说明**: 用于存储 Yao DSL 配置的 DSL 表

**主要字段**:

- `dsl_id`: DSL 标识符（唯一）
- `type`: DSL 类型（model/api/table/form/list/chart/dashboard/connector/store/schedule/flow/pipe/aigc/sui 等）
- `label`: DSL 显示标签
- `path`: DSL 文件路径
- `sort`: 数据排序的排序顺序
- `description`: DSL 描述
- `source`: DSL 源内容
- `tags`: 用于分类和筛选的 DSL 标签
- `dsl`: JSON 格式的 DSL 配置
- `mtime`: 文件修改时间（文件-based DSL）
- `ctime`: 文件创建时间（文件-based DSL）
- `readonly`: DSL 只读状态
- `built_in`: 是否为内置 DSL
- `creator_id`: 创建者用户 ID
- `creator_name`: 创建者用户名
- `updater_id`: 最后更新者用户 ID
- `updater_name`: 最后更新者用户名

---

## 用户与认证模型

### User (用户)

**表名**: `user`  
**标签**: `user`, `profile`, `auth`, `mfa`  
**说明**: 用于存储用户档案和信息的用户表，符合 OIDC 标准

**主要字段**:

**基本字段**:

- `user_id`: 全局唯一用户标识
- `preferred_username`: OIDC 首选用户名
- `email`: OIDC 邮箱地址
- `email_verified`: OIDC 邮箱验证状态
- `name`: OIDC 全名
- `given_name`: OIDC 名字或首名
- `family_name`: OIDC 姓氏或末名
- `middle_name`: OIDC 中间名
- `nickname`: OIDC 昵称
- `profile`: OIDC 个人资料页 URL
- `picture`: OIDC 个人资料图片 URL
- `website`: OIDC 网页或博客 URL
- `gender`: OIDC 性别
- `birthdate`: OIDC 生日（YYYY-MM-DD 格式）
- `zoneinfo`: OIDC 时区信息（IANA 时区数据库格式）
- `locale`: OIDC 区域设置（language-country）
- `phone_number`: OIDC 电话号码
- `phone_number_verified`: OIDC 电话验证状态
- `address`: OIDC 物理邮寄地址（结构化）
- `theme`: 用户界面主题偏好
- `metadata`: 扩展用户元数据和自定义字段

**认证字段**:

- `password_hash`: 用于认证的哈希密码

**用户管理字段**:

- `status`: 用户账户状态（pending/pending_invite/active/disabled/suspended/locked/password_expired/email_unverified/archived）
- `role_id`: 用户角色标识（引用 role.role_id）
- `type_id`: 用户类型标识（引用 user.type.type_id）

**多因素认证 (MFA) 字段**:

- `mfa_enabled`: 是否启用多因素认证
- `mfa_secret`: TOTP 共享密钥（Base32 编码）
- `mfa_issuer`: 认证器应用中显示的颁发者名称
- `mfa_algorithm`: TOTP 算法（SHA1/SHA256/SHA512）
- `mfa_digits`: TOTP 代码位数（6 或 8）
- `mfa_period`: TOTP 时间段（秒，通常为 30）
- `mfa_recovery_hash`: 用于 MFA 备份认证的哈希恢复码
- `mfa_enabled_at`: 启用多因素认证的时间

**用户活动跟踪字段**:

- `last_login_at`: 最后登录时间戳
- `last_login_ip`: 最后登录 IP 地址
- `last_login_user_agent`: 最后登录用户代理字符串
- `last_login_device`: 最后登录设备类型（mobile/desktop/tablet）
- `last_login_platform`: 最后登录平台（ios/android/web）
- `mfa_last_verified_at`: 最后验证多因素认证的时间
- `password_changed_at`: 最后修改密码的时间

**索引**:

- `idx_user_mfa`: 多因素认证状态和时间索引
- `idx_user_verification`: 验证状态索引
- `idx_user_locale_zoneinfo`: 区域设置和时区索引

**关联关系**:

- `role`: hasOne 关联到 \_\_yao.role
- `type`: hasOne 关联到 \_\_yao.user.type
- `oauth_accounts`: hasMany 关联到 \_\_yao.user.oauth_account
- `owned_teams`: hasMany 关联到 \_\_yao.team
- `team_memberships`: hasMany 关联到 \_\_yao.member
- `teams`: hasManyThrough 关联到 **yao.team（通过 **yao.member）

---

### User Type (用户类型)

**表名**: `user_type`  
**标签**: `user`, `type`, `classification`, `config`  
**说明**: 用户类型分类和配置

**主要字段**:

- `type_id`: 唯一类型标识符（admin/customer/guest 等）
- `name`: 用户类型的显示名称
- `description`: 用户类型的详细描述
- `default_role_id`: 分配给此类用户的默认角色（引用 role.role_id）
- `schema`: 定义元数据结构和 UI 配置的 JSON schema
- `metadata`: 此用户类型的其他配置和设置
- `is_active`: 此用户类型当前是否激活
- `is_default`: 是否为新注册的默认用户类型
- `sort_order`: 排序的显示顺序
- `status`: 计划管理的发布状态（draft/published/archived）
- `locale`: 语言区域设置（如 en-us, zh-cn）

**定价与订阅字段**:

- `price_daily`: 每日订阅价格（美分，如 100 表示 $1.00）
- `price_monthly`: 每月订阅价格（美分，如 2900 表示 $29.00）
- `price_yearly`: 每年订阅价格（美分，如 29900 表示 $299.00）
- `credits_monthly`: 每月信用/配额分配
- `introduction`: 计划介绍（支持 HTML/Markdown）
- `sale_type`: 销售方式（online/offline）
- `sale_link`: 销售链接 URL（用于离线购买或外部支付）
- `sale_price_label`: 离线销售的自定义价格标签
- `sale_description`: 离线销售的简要说明

**访问控制字段**:

- `max_sessions`: 此用户类型允许的最大并发会话数
- `session_timeout`: 会话超时时间（分钟，0 = 无超时）
- `password_policy`: 此用户类型的密码要求和策略

**功能标志**:

- `features`: 此用户类型可用的功能标志和功能
- `limits`: 此用户类型的使用限制和配额

**索引**:

- `idx_type_active`: 激活用户类型与排序索引
- `idx_type_default`: 默认激活用户类型索引

**关联关系**:

- `default_role`: hasOne 关联到 \_\_yao.role
- `users`: hasMany 关联到 \_\_yao.user

---

### OAuth Account (OAuth 账户)

**表名**: `user_oauth_account`  
**标签**: `user`, `oauth`, `social`, `external`, `provider`  
**说明**: 存储用户的第三方 OAuth 账户信息

**主要字段**:

**基本字段**:

- `user_id`: 引用主用户账户
- `provider`: OAuth 提供者名称（google/apple/github 等）

**OIDC 提供者标准声明**:

- `sub`: 来自提供者的 OIDC subject 标识符（sub claim）
- `preferred_username`: 来自提供者的 OIDC 首选用户名
- `email`: 来自提供者的 OIDC 邮箱地址
- `email_verified`: 来自提供者的 OIDC 邮箱验证状态
- `name`: 来自提供者的 OIDC 全名
- `given_name`: 来自提供者的 OIDC 名字或首名
- `family_name`: 来自提供者的 OIDC 姓氏或末名
- `middle_name`: 来自提供者的 OIDC 中间名
- `nickname`: 来自提供者的 OIDC 昵称
- `profile`: 来自提供者的 OIDC 个人资料页 URL
- `picture`: 来自提供者的 OIDC 个人资料图片 URL
- `website`: 来自提供者的 OIDC 网页或博客 URL
- `gender`: 来自提供者的 OIDC 性别
- `birthdate`: 来自提供者的 OIDC 生日（YYYY-MM-DD 格式）
- `zoneinfo`: 来自提供者的 OIDC 时区信息
- `locale`: 来自提供者的 OIDC 区域设置（language-country）
- `phone_number`: 来自提供者的 OIDC 电话号码
- `phone_number_verified`: 来自提供者的 OIDC 电话验证状态
- `address`: 来自提供者的 OIDC 物理邮寄地址（结构化）
- `raw`: 来自提供者的 OIDC 原始用户信息响应

**账户管理字段**:

- `last_login_at`: 通过此 OAuth 提供者最后登录的时间
- `is_active`: 此 OAuth 账户是否仍激活

**索引**:

- `idx_oauth_account_user_provider`: 唯一约束：每个用户每个提供者一个账户
- `idx_oauth_account_provider_sub`: 唯一约束：每个提供者 sub claim 一个记录
- `idx_oauth_account_email`: 按提供者的邮箱查找索引
- `idx_oauth_account_active`: 激活账户查询索引

**关联关系**:

- `user`: hasOne 关联到 \_\_yao.user

---

### Invitation Code (邀请码)

**表名**: `invitation_code`  
**标签**: `invitation`, `code`, `access`, `beta`, `registration`  
**说明**: 用于平台访问控制的官方邀请码管理

**主要字段**:

**基本字段**:

- `code`: 唯一邀请码字符串
- `owner_id`: 拥有此邀请码的用户 ID（null = 官方/系统生成）

**使用信息**:

- `used_by`: 使用此邀请码的用户 ID
- `used_at`: 使用邀请码的时间

**状态管理**:

- `status`: 邀请码状态（draft/active/used/expired/revoked/suspended）
- `is_published`: 是否已发布并可使用
- `published_at`: 邀请码发布时间

**过期**:

- `expires_at`: 邀请码过期时间

**代码配置**:

- `code_type`: 邀请码类型（official/beta/partner/promotional/custom）

**其他信息**:

- `description`: 关于此邀请码的描述或备注
- `source`: 分发此代码的来源或渠道
- `metadata`: 其他元数据和自定义字段

**索引**:

- `idx_invitation_code_status_published`: 状态和发布标志索引
- `idx_invitation_code_owner_status`: 所有者和状态索引
- `idx_invitation_code_type_status`: 类型和状态索引
- `idx_invitation_code_expires`: 状态和过期时间索引
- `idx_invitation_code_available`: 可用代码索引
- `idx_invitation_code_published_at`: 发布标志和时间索引
- `idx_invitation_code_source`: 来源和类型索引

**关联关系**:

- `owner`: hasOne 关联到 \_\_yao.user
- `user`: hasOne 关联到 \_\_yao.user

---

## 团队与成员模型

### Team (团队)

**表名**: `team`  
**标签**: `team`, `structure`, `business`, `verification`  
**说明**: 用于存储团队结构和信息的团队表

**主要字段**:

**基本字段**:

- `team_id`: 全局唯一团队标识
- `name`: 官方团队名称
- `display_name`: 团队显示名称或品牌名称
- `description`: 团队描述
- `website`: 团队网站 URL
- `logo`: 团队 logo URL

**团队所有权**:

- `owner_id`: 团队所有者用户标识（引用 user.user_id）

**联系信息（可选）**:

- `contact_email`: 团队联系邮箱地址
- `contact_phone`: 团队联系电话

**团队验证**:

- `is_verified`: 团队是否已验证
- `verified_at`: 团队验证时间
- `verified_by`: 谁验证了此团队

**团队唯一代码和类型**:

- `team_code`: 唯一团队识别码
- `team_code_type`: 团队识别码类型（DUNS/LEI/GS1/EIN/VAT/CNPJ 等全球标准）
- `status`: 团队状态（pending/active/inactive/suspended/archived）
- `role_id`: 团队所有者角色标识（引用 role.role_id）
- `type_id`: 团队类型标识（引用 user.type.type_id）
- `type`: 团队类型（corporation/llc/partnership/sole_proprietorship/nonprofit/government/educational/other）

**地址信息**:

- `address`: 团队物理地址（结构化 JSON，包含完整详细信息）
- `street_address`: 街道地址行（用于快速访问和索引）
- `city`: 团队所在城市
- `state_province`: 州、省或行政区
- `postal_code`: 邮政编码、邮编或等效代码
- `country`: 团队所在国家（ISO 3166-1 alpha-2）
- `country_name`: 完整国家名称用于显示
- `region`: 地理区域（如北美、欧洲、亚太）
- `zoneinfo`: 团队主时区（IANA 时区数据库格式）

**团队设置**:

- `settings`: 团队配置设置
- `metadata`: 扩展团队元数据和自定义字段

**索引**:

- `idx_team_owner_status`: 所有者和状态索引
- `idx_team_verification`: 验证状态和时间索引
- `idx_team_code_type`: 团队代码类型和代码索引
- `idx_team_location`: 国家、州/省和城市的地理位置查询索引
- `idx_team_region_type`: 地理区域和团队类型索引
- `idx_team_postal_zoneinfo`: 邮政编码和时区的位置服务索引
- `idx_team_type_status`: 团队类型和状态的限制和权限索引
- `idx_team_role_type`: 团队所有者角色和类型的权限查询索引

**关联关系**:

- `owner`: hasOne 关联到 \_\_yao.user
- `role`: hasOne 关联到 \_\_yao.role
- `user_type`: hasOne 关联到 \_\_yao.user.type
- `members`: hasMany 关联到 \_\_yao.member
- `users`: hasManyThrough 关联到 **yao.user（通过 **yao.member）

---

### Member (成员)

**表名**: `member`  
**标签**: `team`, `user`, `association`, `membership`, `roles`  
**说明**: 用于存储团队成员及其角色的关联表

**主要字段**:

**基本字段**:

- `member_id`: 全局唯一成员标识
- `team_id`: 团队标识（引用 team.team_id）
- `user_id`: 用户标识（引用 user.user_id，robot 成员为 null）

**成员类型和配置**:

- `member_type`: 成员类型（user 人类成员 / robot 自动化成员）

**成员档案字段（团队特定身份，用户和机器人共享）**:

- `display_name`: 团队内此成员的显示名称（用户可与 user.name 不同，机器人为机器人名称）
- `bio`: 团队内此成员的个人简介/描述（机器人为机器人描述）
- `avatar`: 此成员的头像/图标 URL（用户和机器人共享）
- `email`: 团队内此成员的邮箱（可与 user.email 不同，用于通信包括机器人）

**角色和权限字段**:

- `role_id`: 团队内的用户角色（引用 role.role_id）
- `is_owner`: 此成员是否为团队所有者（用于查询性能和 UI 显示的冗余字段）
- `status`: 成员身份状态（pending/active/inactive/suspended）

**机器人身份和角色字段（仅用于机器人成员）**:

- `system_prompt`: 机器人成员的身份和角色提示/指令（定义机器人个性和行为）
- `manager_id`: 此机器人成员的直接经理/主管的用户 ID

**机器人配置字段（仅用于机器人成员）**:

- `robot_email`: 用于接收和发送邮件的机器人全局唯一邮箱地址
- `authorized_senders`: 授权发送指令给此机器人的邮箱白名单
- `email_filter_rules`: 邮件过滤规则（支持正则模式）
- `robot_config`: 机器人特定配置（行为设置、调度、活动模式和能力）
- `agents`: 机器人可交互的 AI agents 列表
- `mcp_servers`: 机器人可访问的 MCP servers 列表
- `language_model`: 机器人使用的语言模型（如 gpt-4、claude-3-opus）
- `cost_limit`: 机器人操作的月度成本限制（USD）
- `autonomous_mode`: 机器人是否可以自主操作并执行自动化任务

**机器人活动和状态跟踪**:

- `last_robot_activity`: 机器人最后执行自动化活动的时间
- `robot_status`: 机器人成员的当前运行状态（idle/working/paused/error/maintenance）

**邀请和加入信息**:

- `invitation_id`: 待处理邀请的唯一邀请标识
- `invited_by`: 发送邀请的用户 ID
- `invited_at`: 发送邀请的时间
- `joined_at`: 用户接受并加入团队的时间
- `invitation_token`: 用于邀请接受的唯一令牌
- `invitation_expires_at`: 邀请过期时间

**活动跟踪**:

- `last_active_at`: 用户在此团队中最后活动的时间
- `login_count`: 用户访问此团队的次数

**元数据**:

- `notes`: 关于此成员身份的内部备注
- `metadata`: 此成员身份的其他元数据

**索引**:

- `idx_team_user_unique`: 唯一约束：一个用户在每个团队只有一个成员身份
- `idx_team_invitation_unique`: 唯一约束：每个团队一个 invitation_id（用于待处理邀请）
- `idx_team_email`: 团队内按邮箱查询成员的索引
- `idx_team_member_type_role`: 团队内按类型、角色和状态查找成员的索引
- `idx_team_owner`: 快速查找团队所有者的索引
- `idx_user_teams`: 按成员类型查找用户所有团队的索引
- `idx_robot_members`: 查找激活机器人成员的索引
- `idx_robot_activity`: 机器人活动调度的索引
- `idx_robot_type_status`: 按状态查找机器人成员的索引
- `idx_robot_display_name`: 按显示名称查找机器人成员的索引
- `idx_robot_manager`: 按经理查找机器人的索引
- `idx_team_invitations`: 邀请管理的索引
- `idx_invitation_id`: 邀请 ID 查找和状态的索引
- `idx_invitation_token`: 邀请令牌查找和过期的索引
- `idx_team_activity`: 团队活动跟踪的索引
- `idx_team_display_name`: 团队内按显示名称搜索成员的索引

**关联关系**:

- `team`: hasOne 关联到 \_\_yao.team
- `user`: hasOne 关联到 \_\_yao.user
- `inviter`: hasOne 关联到 \_\_yao.user
- `role`: hasOne 关联到 \_\_yao.role

---

### Role (角色)

**表名**: `role`  
**标签**: `role`, `permission`, `auth`, `rbac`  
**说明**: 角色和权限管理

**主要字段**:

**基本字段**:

- `role_id`: 唯一角色标识符（admin/user/moderator 等）
- `name`: 角色的显示名称
- `description`: 角色及其用途的详细描述

**权限字段**:

- `permissions`: 包含所有权限和访问权限的 JSON 对象
- `restricted_permissions`: 明确拒绝的权限的 JSON 数组

**层级字段**:

- `parent_role_id`: 用于继承的父角色（可选）
- `level`: 角色层级级别（更高 = 更多权限）

**管理字段**:

- `is_active`: 此角色当前是否激活
- `is_default`: 是否为新用户的默认角色
- `is_system`: 是否为系统角色（不可删除）
- `sort_order`: 排序的显示顺序

**显示字段**:

- `color`: UI 显示的颜色代码（十六进制格式）
- `icon`: UI 显示的图标标识符

**访问控制字段**:

- `max_users`: 可以拥有此角色的最大用户数（0 = 无限制）
- `requires_approval`: 分配此角色是否需要管理员批准
- `auto_revoke_days`: 此角色自动撤销的天数（0 = 从不）

**扩展配置**:

- `metadata`: 其他角色配置和设置
- `conditions`: 分配/维护此角色必须满足的条件

**索引**:

- `idx_role_active`: 激活角色与排序索引
- `idx_role_hierarchy`: 角色层级查询索引
- `idx_role_system`: 系统角色查询索引
- `idx_role_default`: 默认激活角色查询索引

**关联关系**:

- `members`: hasMany 关联到 \_\_yao.member
- `users`: hasMany 关联到 \_\_yao.user

---

## AI 助手模型

### Assistant (助手)

**表名**: `agent_assistant`  
**标签**: `agent`, `system`  
**说明**: 用于存储 AI 助手配置和元数据的助手表

**主要字段**:

- `assistant_id`: 助手标识符（唯一）
- `type`: 助手类型
- `name`: 助手名称
- `avatar`: 助手头像 URL
- `connector`: 助手默认连接器（如果未设置，使用全局默认连接器）
- `connector_options`: 连接器选择选项（可选标志、可用连接器列表和能力过滤器）
- `description`: 助手描述
- `path`: 助手存储路径
- `sort`: 助手排序顺序
- `built_in`: 是否为内置助手
- `placeholder`: 助手占位符
- `options`: 助手选项
- `prompts`: 助手默认提示
- `prompt_presets`: 按模式组织的提示预设（如 chat、task 等）
- `disable_global_prompts`: 是否为此助手禁用全局提示
- `workflow`: 助手工作流
- `kb`: 助手知识库集合
- `db`: 助手数据库模型
- `mcp`: 助手可用的 MCP servers
- `source`: Hook 脚本源代码
- `tags`: 助手标签
- `modes`: 支持的模式（如 chat、task），null 表示支持所有模式
- `default_mode`: 助手的默认模式
- `readonly`: 助手只读状态
- `public`: 是否跨平台所有团队共享的助手
- `share`: 助手共享范围（private/team）
- `locales`: 助手 i18n 区域设置
- `uses`: 助手特定的 vision、audio 等包装器配置
- `search`: 搜索配置（web/kb/db/citation/weights 等）
- `automated`: 助手自动化状态
- `mentionable`: 此助手是否可出现在 @ 提及列表中

**索引**:

- `idx_agent_assistant_type_builtin`: 助手类型和内置状态索引
- `idx_agent_assistant_sort`: 助手排序和自动化索引

**关联关系**:

- `chats`: hasMany 关联到 \_\_yao.agent.chat

---

### Chat (聊天会话)

**表名**: `agent_chat`  
**标签**: `agent`, `system`  
**说明**: 用于存储聊天元数据和会话信息的聊天会话表

**主要字段**:

- `chat_id`: 唯一聊天标识符
- `title`: 聊天标题
- `assistant_id`: 关联的助手 ID
- `last_connector`: 最后使用的连接器 ID（每条消息更新）
- `last_mode`: 最后使用的聊天模式（每条消息更新）
- `status`: 聊天状态（active/archived）
- `public`: 是否跨所有团队共享
- `share`: 共享范围（private/team）
- `sort`: 显示的排序顺序
- `last_message_at`: 最后一条消息的时间戳
- `metadata`: 其他元数据

**关联关系**:

- `assistant`: hasOne 关联到 \_\_yao.agent.assistant
- `messages`: hasMany 关联到 \_\_yao.agent.message
- `resumes`: hasMany 关联到 \_\_yao.agent.resume

---

### Message (消息)

**表名**: `agent_message`  
**标签**: `agent`, `system`  
**说明**: 用于存储用户可见消息的聊天消息表

**主要字段**:

- `message_id`: 消息标识符（请求内唯一）
- `chat_id`: 父聊天 ID
- `request_id`: 用于分组的请求 ID
- `role`: 消息角色（user/assistant）
- `type`: 消息类型（text/image/loading/tool_call/retrieval 等）
- `props`: 消息属性（content、url 等）
- `block_id`: 块分组 ID
- `thread_id`: 并发操作的线程分组 ID
- `assistant_id`: 助手 ID（连接获取 name/avatar）
- `connector`: 此消息使用的连接器 ID
- `mode`: 此消息使用的聊天模式（chat 或 task）
- `sequence`: 聊天中的消息顺序
- `metadata`: 其他元数据（tool_call_id、tool_name 等）

**索引**:

- `idx_msg_chat_seq`: 聊天内消息排序索引
- `idx_msg_request_message`: 请求内 message_id 的唯一约束

**关联关系**:

- `chat`: hasOne 关联到 \_\_yao.agent.chat
- `assistant`: hasOne 关联到 \_\_yao.agent.assistant

---

### Resume (恢复记录)

**表名**: `agent_resume`  
**标签**: `agent`, `system`  
**说明**: 用于存储恢复/重试功能的执行状态的恢复表

**主要字段**:

- `resume_id`: 唯一恢复记录标识符
- `chat_id`: 父聊天 ID
- `request_id`: 请求 ID
- `assistant_id`: 执行此步骤的助手
- `stack_id`: 此执行的堆栈节点 ID
- `stack_parent_id`: 父堆栈 ID（用于 A2A 调用）
- `stack_depth`: 调用深度（0=根，1+=嵌套）
- `type`: 步骤类型（input/hook_create/llm/tool/hook_next/delegate）
- `status`: 恢复状态（仅存储中断或失败的，interrupted/failed）
- `input`: 步骤输入数据
- `output`: 步骤输出数据（部分）
- `space_snapshot`: 用于恢复的空间数据快照
- `error`: 失败时的错误消息
- `sequence`: 请求内的步骤顺序
- `metadata`: 其他元数据

**索引**:

- `idx_resume_request_seq`: 请求内恢复排序索引

**关联关系**:

- `chat`: hasOne 关联到 \_\_yao.agent.chat
- `assistant`: hasOne 关联到 \_\_yao.agent.assistant

---

### Search (搜索记录)

**表名**: `agent_search`  
**标签**: `agent`, `system`  
**说明**: 用于引用支持和调试的搜索记录

**主要字段**:

- `request_id`: 关联的请求 ID
- `chat_id`: 关联的聊天 ID
- `query`: 原始搜索查询
- `config`: 使用的搜索配置（用于调优）
- `keywords`: 提取的关键词（来自 NLP）
- `entities`: 提取的实体（用于图搜索）
- `relations`: 提取的关系（用于图搜索）
- `dsl`: 生成的 QueryDSL（用于 DB 搜索）
- `source`: 搜索来源（web/kb/db/auto）
- `references`: 带全局索引的 Reference[]
- `graph`: 来自知识图谱的 GraphNode[]
- `xml`: 用于 LLM 上下文的格式化 XML
- `prompt`: 引用指令提示
- `duration`: 搜索持续时间（毫秒）
- `error`: 失败时的错误消息

**关联关系**:

- `chat`: hasOne 关联到 \_\_yao.agent.chat

---

## 任务调度模型

### Job (任务)

**表名**: `job`  
**标签**: `system`  
**说明**: 用于管理任务执行和调度的任务表

**主要字段**:

- `job_id`: 任务唯一字符串标识
- `name`: 任务显示名称
- `icon`: 任务图标标识符
- `description`: 任务描述
- `category_id`: 此任务所属类别的引用
- `max_worker_nums`: 此任务的最大并发工作器数
- `status`: 任务总体状态（draft/ready/running/paused/completed/failed/disabled）
- `mode`: 任务执行模式（GOROUTINE/PROCESS）
- `schedule_type`: 任务调度模式（once/cron/daemon）
- `schedule_expression`: 计划任务的 cron 表达式
- `max_retry_count`: 失败时的最大重试次数
- `default_timeout`: 默认执行超时时间（秒）
- `priority`: 任务执行优先级（数字越高 = 优先级越高）
- `created_by`: 创建此任务的用户
- `next_run_at`: 下一次计划执行的时间戳
- `last_run_at`: 最后一次执行的时间戳
- `current_execution_id`: 引用当前/最新执行实例
- `config`: 任务配置参数
- `sort`: 显示的排序顺序
- `enabled`: 此任务是否启用执行
- `system`: 是否为系统任务
- `readonly`: 此任务是否只读

**索引**:

- `idx_job_category_status`: 类别和状态组合索引
- `idx_job_mode_status`: 模式和状态组合索引
- `idx_job_schedule_type_next_run`: 计划任务查询组合索引
- `idx_job_created_by_status`: 用户任务查询组合索引

---

### Job Category (任务类别)

**表名**: `job_category`  
**标签**: `system`  
**说明**: 用于组织不同类型任务的类别表

**主要字段**:

- `category_id`: 类别的唯一字符串标识
- `name`: 类别的显示名称
- `icon`: 类别的图标标识符
- `description`: 类别描述
- `sort`: 显示的排序顺序
- `system`: 是否为系统类别
- `enabled`: 此类别是否启用
- `readonly`: 此类别是否只读

---

### Job Execution (任务执行)

**表名**: `job_execution`  
**标签**: `system`  
**说明**: 用于跟踪单个执行实例的任务执行表

**主要字段**:

- `execution_id`: 执行实例的唯一字符串标识
- `job_id`: 引用此执行所属的任务
- `status`: 执行实例状态（queued/initializing/running/completed/failed/cancelled/timeout/killed）
- `trigger_category`: 高级触发类别（manual/scheduled/event/api/system/dependency）
- `trigger_source`: 特定触发源标识符（可扩展）
- `trigger_context`: 其他触发上下文和元数据
- `scheduled_at`: 此执行计划运行的时间（用于计划任务）
- `worker_id`: 处理此执行的工作器实例
- `process_id`: 重型执行的进程 ID
- `retry_attempt`: 这是第几次重试（首次尝试为 0）
- `parent_execution_id`: 如果是重试，引用父执行
- `started_at`: 执行开始的时间戳
- `ended_at`: 执行结束的时间戳
- `timeout_seconds`: 此执行使用的实际超时时间（继承自任务或覆盖）
- `duration`: 执行持续时间（毫秒）
- `priority`: 执行优先级（数字越高 = 优先级越高）
- `progress`: 执行进度百分比（0-100）
- `execution_options`: 执行选项（包括优先级和共享数据）
- `config_snapshot`: 执行时间的任务配置快照
- `result`: 执行结果数据
- `error_info`: 执行失败时的结构化错误信息
- `stack_trace`: 执行失败时的堆栈跟踪信息
- `metrics`: 执行指标（如内存使用、CPU 时间等）
- `context`: 其他执行上下文和元数据

**索引**:

- `idx_execution_job_started`: 任务执行历史查询组合索引
- `idx_execution_status_started`: 基于状态与时间排序的组合索引
- `idx_execution_worker_started`: 工作器执行历史组合索引
- `idx_execution_trigger_started`: 触发类别分析组合索引
- `idx_execution_trigger_source`: 触发源分析组合索引
- `idx_execution_parent_retry`: 重试链跟踪组合索引

---

### Job Log (任务日志)

**表名**: `job_log`  
**标签**: `system`  
**说明**: 用于跟踪任务执行日志和事件的任务日志表

**主要字段**:

- `job_id`: 引用此日志所属的任务
- `level`: 日志级别（debug/info/warning/error/fatal/retry）
- `message`: 日志消息内容
- `context`: 日志条目的其他上下文数据
- `source`: 生成此日志的源组件或模块
- `execution_id`: 此执行运行的唯一标识符（用于重试场景）
- `step`: 生成此日志的执行步骤或阶段
- `progress`: 生成此日志时的进度百分比（0-100）
- `duration`: 操作持续时间（毫秒，如适用）
- `error_code`: 错误级别日志的错误代码
- `stack_trace`: 错误日志的堆栈跟踪
- `worker_id`: 生成此日志的工作器实例
- `process_id`: 重型任务的进程 ID
- `timestamp`: 生成日志的时间戳
- `sequence`: 任务执行内的序列号（用于排序）

**索引**:

- `idx_log_job_timestamp`: 按时间排序的任务日志查询组合索引
- `idx_log_job_level`: 按任务和级别过滤日志的组合索引
- `idx_log_execution_sequence`: 执行内日志排序的组合索引
- `idx_log_level_timestamp`: 按级别和时间过滤日志的组合索引
- `idx_log_worker_timestamp`: 工作器特定日志查询的组合索引

---

## 知识库模型

### Collection (集合)

**表名**: `kb_collection`  
**标签**: `system`  
**说明**: 用于存储知识库集合的集合表

**主要字段**:

- `collection_id`: 集合唯一字符串标识（来自 API）
- `name`: 集合显示名称
- `description`: 集合描述
- `status`: 集合状态（creating/active/maintenance/restoring/error/disabled）
- `preset`: 是否为预设集合
- `public`: 是否跨平台所有团队共享
- `share`: 集合共享范围（private/team）
- `sort`: 显示的排序顺序
- `cover`: 集合封面图片 URL
- `document_count`: 集合中的文档数量
- `embedding_provider_id`: 知识嵌入提供者 ID（可选）
- `embedding_option_id`: 知识嵌入提供者选项 ID（可选）
- `embedding_properties`: 嵌入提供者配置属性
- `locale`: 集合的区域设置
- `distance`: 向量距离计算方法（cosine/euclidean/dot）
- `index_type`: 向量索引算法类型（hnsw/ivf/flat）
- `m`: HNSW M 参数（每个节点的双向链接数）
- `ef_construction`: HNSW EF construction 参数
- `ef_search`: HNSW EF search 参数
- `num_lists`: IVF 算法集群数
- `num_probes`: IVF 算法搜索的集群数

---

### Document (文档)

**表名**: `kb_document`  
**标签**: `system`  
**说明**: 用于存储知识库文档的文档表

**主要字段**:

- `document_id`: 文档唯一字符串标识（来自 API）
- `collection_id`: 引用此文档所属的集合
- `name`: 文档显示名称
- `description`: 文档描述
- `status`: 文档处理状态（pending/converting/chunking/extracting/embedding/storing/completed/maintenance/restoring/error）
- `type`: 文档内容类型（file/text/url）
- `size`: 文档大小（字节）
- `segment_count`: 此文档生成的片段数
- `job_id`: 跟踪文档处理任务的处理作业标识
- `uploader_id`: 用于文件管理和附件系统的上传者标识
- `tags`: 用于分类和筛选的文档标签
- `locale`: 提供者读取和处理的区域设置
- `preset`: 是否为预设文档
- `public`: 是否跨平台所有团队共享
- `share`: 文档共享范围（private/team）
- `sort`: 显示的排序顺序
- `cover`: 文档封面图片 URL
- `file_id`: 附件系统的文件标识符（用于文件类型）
- `file_name`: 原始文件名（用于文件类型）
- `file_path`: 文件存储路径（用于文件类型）
- `file_mime_type`: 文件的 MIME 类型（用于文件类型）
- `url`: 源 URL（用于 url 类型）
- `url_title`: 从 URL 提取的标题（用于 url 类型）
- `text_content`: 原始文本内容（用于文本类型或处理后的内容）
- `converter_provider_id`: 文档转换器提供者 ID（用于文件类型）
- `converter_option_id`: 文档转换器提供者选项 ID（用于文件类型）
- `converter_properties`: 转换器提供者配置属性
- `fetcher_provider_id`: URL 抓取器提供者 ID（用于 url 类型）
- `fetcher_option_id`: URL 抓取器提供者选项 ID（用于 url 类型）
- `fetcher_properties`: 抓取器提供者配置属性
- `chunking_provider_id`: 文本分块提供者 ID
- `chunking_option_id`: 文本分块提供者选项 ID
- `chunking_properties`: 分块提供者配置属性（包括 split_mode、chunk_size、chunk_overlap 等）
- `embedding_provider_id`: 知识嵌入提供者 ID（可选）
- `embedding_option_id`: 知识嵌入提供者选项 ID（可选）
- `embedding_properties`: 嵌入提供者配置属性
- `extraction_provider_id`: 知识提取提供者 ID（可选）
- `extraction_option_id`: 知识提取提供者选项 ID（可选）
- `extraction_properties`: 提取提供者配置属性
- `processed_at`: 文档处理完成的时间戳
- `error_message`: 处理失败时的错误消息

---

## 模型 ID 映射

每个模型都有一个唯一标识符，内置模型以 `__yao` 作为前缀，格式为 `__yao.<模型文件路径>`。

### ID 列表

| 模型 ID                    | 模型文件路径                            | 模型描述                       |
| -------------------------- | --------------------------------------- | ------------------------------ |
| `__yao.agent.assistant`    | `yao/models/agent/assistant.mod.yao`    | AI 助手配置和元数据            |
| `__yao.agent.chat`         | `yao/models/agent/chat.mod.yao`         | 聊天元数据和会话信息           |
| `__yao.agent.message`      | `yao/models/agent/message.mod.yao`      | 用户可见的聊天消息             |
| `__yao.agent.resume`       | `yao/models/agent/resume.mod.yao`       | 恢复/重试功能的执行状态        |
| `__yao.agent.search`       | `yao/models/agent/search.mod.yao`       | 搜索记录，用于引用支持和调试   |
| `__yao.attachment`         | `yao/models/attachment.mod.yao`         | 文件附件及其元数据和访问控制   |
| `__yao.audit`              | `yao/models/audit.mod.yao`              | 系统操作审计记录               |
| `__yao.config`             | `yao/models/config.mod.yao`             | 系统设置和参数                 |
| `__yao.dsl`                | `yao/models/dsl.mod.yao`                | Yao DSL 配置                   |
| `__yao.invitation`         | `yao/models/invitation.mod.yao`         | 平台访问控制的官方邀请码管理   |
| `__yao.job.category`       | `yao/models/job/category.mod.yao`       | 组织不同类型任务的类别         |
| `__yao.job`                | `yao/models/job/job.mod.yao`            | 任务执行和调度管理             |
| `__yao.job.execution`      | `yao/models/job/execution.mod.yao`      | 跟踪单个执行实例               |
| `__yao.job.log`            | `yao/models/job/log.mod.yao`            | 任务执行日志和事件跟踪         |
| `__yao.kb.collection`      | `yao/models/kb/collection.mod.yao`      | 知识库集合                     |
| `__yao.kb.document`        | `yao/models/kb/document.mod.yao`        | 知识库文档                     |
| `__yao.team`               | `yao/models/team.mod.yao`               | 团队结构和信息                 |
| `__yao.member`             | `yao/models/member.mod.yao`             | 团队成员及其角色关联           |
| `__yao.user`               | `yao/models/user.mod.yao`               | 用户档案和信息，符合 OIDC 标准 |
| `__yao.role`               | `yao/models/role.mod.yao`               | 角色和权限管理                 |
| `__yao.user.type`          | `yao/models/user/type.mod.yao`          | 用户类型分类和配置             |
| `__yao.user.oauth_account` | `yao/models/user/oauth_account.mod.yao` | 用户的第三方 OAuth 账户信息    |

---

## 模型统计

| 模型类别       | 模型数量 |
| -------------- | -------- |
| 核心系统模型   | 4        |
| 用户与认证模型 | 4        |
| 团队与成员模型 | 3        |
| AI 助手模型    | 5        |
| 任务调度模型   | 4        |
| 知识库模型     | 2        |
| **总计**       | **22**   |

## 模型标签分类

- `system`: 系统内置模型
- `user`: 用户相关模型
- `agent`: AI 助手相关模型
- `team`: 团队相关模型
- `role`: 角色权限相关模型
- `invitation`: 邀请相关模型
- `profile`: 用户档案相关模型
- `auth`: 认证相关模型
- `mfa`: 多因素认证相关模型
- `oauth`: OAuth 相关模型
- `social`: 社交登录相关模型
- `external`: 外部集成相关模型
- `provider`: 提供者相关模型
- `type`: 类型分类相关模型
- `classification`: 分类相关模型
- `config`: 配置相关模型
- `structure`: 结构相关模型
- `business`: 业务相关模型
- `verification`: 验证相关模型
- `association`: 关联相关模型
- `membership`: 成员身份相关模型
- `roles`: 角色相关模型
- `access`, `beta`, `registration`: 访问控制相关模型

---

**更新日期**: 2026-01-14  
**Yao 版本**: 最新版本
